<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å°é³¥å¤§å†’éšª - é—œå¡é¸æ“‡ç‰ˆ (æŒ‰éµä¿®æ­£)</title>
    <!-- Accessibility improvements -->
    <meta name="description" content="æ‰“å°é³¥å°„æ“ŠéŠæˆ²ï¼Œæ”¯æŒéµç›¤å’Œè§¸æ§æ“ä½œï¼ŒåŒ…å«å¤šé—œå¡æŒ‘æˆ°">
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #ff5252;
            --warning: #FFC107;
            --dark: #333;
            --light: #f5f5f5;
            --glass: rgba(255, 255, 255, 0.9);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: var(--dark);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none; /* iOS Safari */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        .main-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ç•«é¢åˆ‡æ›å®¹å™¨ */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            z-index: 10;
        }

        /* --- é¦–é  --- */
        h1.title {
            font-size: 3rem;
            color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            text-align: center;
        }

        .btn-lg {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            touch-action: manipulation; /* æ”¹å–„è§¸æ§å›æ‡‰ */
        }

        .btn-lg:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        /* --- é—œå¡é¸æ“‡é¢æ¿ --- */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 90%;
            max-width: 600px;
            padding: 20px;
        }

        .level-card {
            background: var(--glass);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            touch-action: manipulation;
        }

        .level-card:hover:not(.locked) {
            transform: translateY(-5px);
            border-color: var(--primary);
            background: white;
        }

        .level-card.locked {
            background: rgba(0,0,0,0.5);
            color: #aaa;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .level-num {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-stars {
            font-size: 1.5rem;
            color: #ddd;
            margin-top: 5px;
        }

        .level-stars .star {
            color: #ddd;
        }
        .level-stars .star.earned {
            color: var(--warning);
        }

        .lock-icon {
            font-size: 2rem;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        .back-btn {
            margin-top: 30px;
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 10px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            touch-action: manipulation;
        }

        /* --- éŠæˆ²ä»‹é¢ --- */
        .game-area {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #gameCanvas {
            background: #87CEEB;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            cursor: crosshair;
            max-width: 100%;
            max-height: 65vh; /* ç¨å¾®ç¸®å°é«˜åº¦ç•™ç©ºé–“çµ¦æŒ‰éˆ• */
            display: block;
        }

        .hud {
            width: 600px;
            max-width: 95%;
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
            font-weight: bold;
        }

        /* ä¿®æ­£å¾Œçš„æš«åœæŒ‰éˆ•æ¨£å¼ */
        #pauseExitBtn {
            margin-top: 20px;
            padding: 15px 40px; /* åŠ å¤§é»æ“Šå€åŸŸ */
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.2); /* åŠé€æ˜èƒŒæ™¯ */
            border: 2px solid rgba(255, 255, 255, 0.8);
            color: white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            z-index: 100; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            position: relative; /* ç¢ºä¿ z-index ç”Ÿæ•ˆ */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: background 0.2s;
            touch-action: manipulation;
            backdrop-filter: blur(5px);
        }

        #pauseExitBtn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.98);
        }

        /* çµç®—æ¨¡æ…‹æ¡† */
        .modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: none;
            z-index: 200; /* æ¯”æŒ‰éˆ•é‚„é«˜ */
        }

        .stars-display {
            font-size: 3rem;
            margin: 20px 0;
            color: #ddd;
        }
        .stars-display .star { color: #ddd; display: inline-block; transition: 0.5s; }
        .stars-display .star.earned { color: var(--warning); transform: scale(1.2); text-shadow: 0 0 10px orange; }

        /* å‹•ç•«èˆ‡ç‰¹æ•ˆ */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-4px, 0, 0); }
            20%, 80% { transform: translate3d(6px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        .floating-text {
            position: absolute;
            pointer-events: none;
            font-weight: bold;
            font-size: 1.5rem;
            animation: floatUp 1s forwards;
            z-index: 150; /* æµ®å‹•æ–‡å­—è¦åœ¨æœ€ä¸Šé¢ */
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 650px) {
            .level-grid { grid-template-columns: repeat(2, 1fr); }
            h1.title { font-size: 2rem; }
            #gameCanvas { height: 50vh; width: 95vw; }
            #pauseExitBtn {
                width: 80%; /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å¯¬ä¸€é» */
                padding: 15px 0;
                text-align: center;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        button:focus,
        .level-card:focus {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1001;
        }

        .skip-link:focus {
            top: 0;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* æˆå°±ç³»çµ±æ¨£å¼ */
        .achievements-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 193, 7, 0.9);
            border: none;
            color: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .achievements-btn:hover {
            background: rgba(255, 193, 7, 1);
            transform: scale(1.1);
        }

        @keyframes achievementSlide2 {
            0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes comboGlow2 {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0; }
        }

        /* çµ±è¨ˆé¢æ¿ */
        .stats-panel {
            position: fixed;
            top: 60px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 999;
            min-width: 150px;
            backdrop-filter: blur(5px);
        }

        .stat-item {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .stat-value {
            color: #FFD700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <a href="#game-content" class="skip-link">è·³è‡³éŠæˆ²å…§å®¹</a>
    <div class="main-wrapper" role="main">
        
        <!-- 1. é¦–é  -->
        <div id="home-screen" class="screen active" role="region" aria-label="ä¸»é¸å–®">
            <h1 class="title">æ‰“å°é³¥å¤§å†’éšª<br><span style="font-size: 1.5rem; color:#FFD700">ç‰¹åˆ¥è¡Œå‹•ç‰ˆ</span></h1>
            <button class="btn-lg" onclick="showLevelSelect()" aria-label="é–‹å§‹æ‰“å°é³¥å†’éšª">é–‹å§‹å†’éšª</button>
        </div>

        <!-- 2. é—œå¡é¸æ“‡é¢æ¿ -->
        <div id="level-screen" class="screen" role="region" aria-label="é—œå¡é¸æ“‡">
            <h1 style="color:white; text-shadow: 0 2px 5px rgba(0,0,0,0.5);">é¸æ“‡é—œå¡</h1>
            <div class="level-grid" id="levelGrid" role="grid" aria-label="å¯ç”¨é—œå¡">
                <!-- ç”± JS ç”Ÿæˆ -->
            </div>
            <button class="back-btn" onclick="showHome()" aria-label="è¿”å›ä¸»é¸å–®">è¿”å›ä¸»é¸å–®</button>
        </div>

        <!-- 3. éŠæˆ²ç•«é¢ -->
        <div id="game-screen" class="screen" role="region" aria-label="éŠæˆ²ç•«é¢">
            <!-- æˆå°±æŒ‰éˆ• -->
            <button class="achievements-btn" id="achievementsBtn2" aria-label="æŸ¥çœ‹æˆå°±">ğŸ†</button>
            
            <!-- çµ±è¨ˆé¢æ¿ -->
            <div class="stats-panel" id="statsPanel" aria-label="éŠæˆ²çµ±è¨ˆ">
                <div class="stat-item">
                    <span>å‘½ä¸­ç‡:</span>
                    <span class="stat-value" id="accuracyStat">0%</span>
                </div>
                <div class="stat-item">
                    <span>é€£æ“Š:</span>
                    <span class="stat-value" id="comboStat">0</span>
                </div>
                <div class="stat-item">
                    <span>æœ€ä½³é€£æ“Š:</span>
                    <span class="stat-value" id="bestComboStat">0</span>
                </div>
            </div>
            
            <div class="game-area">
                <div class="hud" role="status" aria-live="polite">
                    <span id="hudLevel">é—œå¡: 1</span>
                    <span id="hudScore">åˆ†æ•¸: 0</span>
                    <span id="hudTimer">30s</span>
                </div>
                <div id="game-content">
                    <canvas id="gameCanvas" width="600" height="400" role="application" aria-label="æ‰“å°é³¥éŠæˆ²ç•«å¸ƒï¼Œä½¿ç”¨æ•¸å­—éµ1-3é¸æ“‡é—œå¡ï¼ŒEnteréµé–‹å§‹ï¼Œé»æ“Šå°„æ“Šï¼ŒEscæš«åœ" tabindex="0"></canvas>
                </div>
                <!-- æš«åœæŒ‰éˆ•æ”¾åœ¨é€™è£¡ï¼Œç¢ºä¿å±¤ç´šé«˜æ–¼ Canvas -->
                <button id="pauseExitBtn" onclick="pauseGame()">æš«åœ / é€€å‡º</button>
            </div>

            <!-- çµç®—å½ˆçª— -->
            <div class="modal" id="resultModal">
                <h2 id="resultTitle">é—œå¡å®Œæˆ!</h2>
                <div class="stars-display" id="resultStars">
                    <span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span>
                </div>
                <p id="resultScore">åˆ†æ•¸: 0</p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn-lg" style="padding:10px 20px; font-size:1rem;" onclick="restartLevel()">é‡ç©</button>
                    <button class="btn-lg" style="padding:10px 20px; font-size:1rem; background:#ccc; color:#333;" onclick="showLevelSelect()">é¸é—œ</button>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- éŠæˆ²æ•¸æ“šé…ç½® ---
    const config = {
        width: 600,
        height: 400,
        totalLevels: 3
    };

    const levels = [
        { name: "åˆç´šè¨“ç·´", time: 30, birdSpeed: [1, 2], birdSize: [40, 60], spawnRate: 1200, bombRate: 0.1, stars: [100, 200, 300] },
        { name: "é€²éšæŒ‘æˆ°", time: 30, birdSpeed: [2, 3.5], birdSize: [30, 50], spawnRate: 900, bombRate: 0.2, stars: [150, 250, 350] },
        { name: "å°ˆå®¶è€ƒé©—", time: 30, birdSpeed: [3, 5], birdSize: [25, 40], spawnRate: 600, bombRate: 0.3, stars: [200, 300, 450] }
    ];

    // ç©å®¶é€²åº¦å­˜æª” - å¢å¼·ç‰ˆ
    let playerProgress = JSON.parse(localStorage.getItem('birdHunterProgress')) || {
        maxUnlocked: 1,
        levelStars: { 1: 0, 2: 0, 3: 0 },
        statistics: {
            totalPlayTime: 0,
            totalScore: 0,
            totalHits: 0,
            totalMisses: 0,
            perfectRounds: 0,
            bestCombo: 0,
            currentCombo: 0,
            birdsHit: { normal: 0, special: 0 },
            bombsHit: 0,
            averageAccuracy: 0,
            gamesPlayed: 0
        },
        achievements: [],
        settings: {
            soundEnabled: true,
            hapticEnabled: true,
            showHints: true
        }
    };

    // æˆå°±ç³»çµ±
    const achievements2 = {
        firstShot: { id: 'firstShot', name: 'åˆæ¬¡å°„æ“Š', desc: 'å®Œæˆç¬¬ä¸€æ¬¡å°„æ“Š', icon: 'ğŸ¯' },
        sharpshooter: { id: 'sharpshooter', name: 'ç¥å°„æ‰‹', desc: 'å–®å±€å‘½ä¸­ç‡é”åˆ°90%', icon: 'ğŸ¹' },
        comboMaster: { id: 'comboMaster', name: 'é€£æ“Šå¤§å¸«', desc: 'é”æˆ10é€£æ“Š', icon: 'âš¡' },
        bombDodger: { id: 'bombDodger', name: 'ç‚¸å½ˆé–ƒé¿è€…', desc: 'å®Œæˆä¸€å±€ä¸æ“Šä¸­ç‚¸å½ˆ', icon: 'ğŸ’£' },
        speedDemon: { id: 'speedDemon', name: 'é€Ÿåº¦æƒ¡é­”', desc: '15ç§’å…§å®Œæˆä¸€é—œ', icon: 'ğŸƒ' },
        perfectionist: { id: 'perfectionist', name: 'å®Œç¾ä¸»ç¾©', desc: 'å®Œç¾é€šé—œï¼ˆå‘½ä¸­ç‡100%ï¼‰', icon: 'ğŸ’' },
        veteran: { id: 'veteran', name: 'è€å…µ', desc: 'å®Œæˆ30å ´éŠæˆ²', icon: 'ğŸ–ï¸' },
        highScorer: { id: 'highScorer', name: 'é«˜åˆ†ç©å®¶', desc: 'å–®å±€å¾—åˆ†è¶…é500', icon: 'ğŸ†' }
    };

    // éŠæˆ²çµ±è¨ˆç®¡ç†å™¨
    class GameStatistics2 {
        constructor() {
            this.sessionStartTime = Date.now();
            this.currentGameStartTime = null;
            this.sessionHits = 0;
            this.sessionMisses = 0;
        }

        startGame() {
            this.currentGameStartTime = Date.now();
            this.sessionHits = 0;
            this.sessionMisses = 0;
            playerProgress.statistics.currentCombo = 0;
        }

        recordHit(isBomb = false, isSpecial = false) {
            playerProgress.statistics.totalHits++;
            this.sessionHits++;
            playerProgress.statistics.currentCombo++;
            
            if (isBomb) {
                playerProgress.statistics.bombsHit++;
                playerProgress.statistics.currentCombo = 0; // é‡ç½®é€£æ“Š
            } else {
                if (isSpecial) {
                    playerProgress.statistics.birdsHit.special++;
                } else {
                    playerProgress.statistics.birdsHit.normal++;
                }
                
                // æª¢æŸ¥é€£æ“Šæˆå°±
                if (playerProgress.statistics.currentCombo > playerProgress.statistics.bestCombo) {
                    playerProgress.statistics.bestCombo = playerProgress.statistics.currentCombo;
                }
            }
            
            this.updateAccuracy();
        }

        recordMiss() {
            playerProgress.statistics.totalMisses++;
            this.sessionMisses++;
            playerProgress.statistics.currentCombo = 0;
            this.updateAccuracy();
        }

        updateAccuracy() {
            const total = playerProgress.statistics.totalHits + playerProgress.statistics.totalMisses;
            if (total > 0) {
                playerProgress.statistics.averageAccuracy = Math.round(
                    (playerProgress.statistics.totalHits / total) * 100
                );
            }
        }

        endGame(finalScore, level, perfect = false) {
            if (!this.currentGameStartTime) return;

            const gameDuration = Date.now() - this.currentGameStartTime;
            
            // æ›´æ–°çµ±è¨ˆ
            playerProgress.statistics.totalPlayTime += gameDuration;
            playerProgress.statistics.totalScore += finalScore;
            playerProgress.statistics.gamesPlayed++;
            
            if (perfect) {
                playerProgress.statistics.perfectRounds++;
            }
            
            // ä¿å­˜æ•¸æ“š
            this.savePlayerData();
            
            // æª¢æŸ¥æˆå°±
            this.checkAchievements(finalScore, level, perfect, gameDuration);
        }

        checkAchievements(score, level, perfect, duration) {
            const newAchievements = [];

            // é¦–æ¬¡å°„æ“Š
            if (playerProgress.statistics.totalHits > 0 && !this.hasAchievement('firstShot')) {
                newAchievements.push(achievements2.firstShot);
            }

            // ç¥å°„æ‰‹
            if (playerProgress.statistics.averageAccuracy >= 90 && !this.hasAchievement('sharpshooter')) {
                newAchievements.push(achievements2.sharpshooter);
            }

            // é€£æ“Šå¤§å¸«
            if (playerProgress.statistics.bestCombo >= 10 && !this.hasAchievement('comboMaster')) {
                newAchievements.push(achievements2.comboMaster);
            }

            // é€Ÿåº¦æƒ¡é­”
            if (duration < 15000 && score > 0 && !this.hasAchievement('speedDemon')) {
                newAchievements.push(achievements2.speedDemon);
            }

            // å®Œç¾ä¸»ç¾©
            if (perfect && !this.hasAchievement('perfectionist')) {
                newAchievements.push(achievements2.perfectionist);
            }

            // é«˜åˆ†ç©å®¶
            if (score >= 500 && !this.hasAchievement('highScorer')) {
                newAchievements.push(achievements2.highScorer);
            }

            // è€å…µ
            if (playerProgress.statistics.gamesPlayed >= 30 && !this.hasAchievement('veteran')) {
                newAchievements.push(achievements2.veteran);
            }

            // é¡¯ç¤ºæ–°æˆå°±
            newAchievements.forEach(achievement => {
                this.unlockAchievement(achievement);
            });
        }

        hasAchievement(id) {
            return playerProgress.achievements.includes(id);
        }

        unlockAchievement(achievement) {
            playerProgress.achievements.push(achievement.id);
            sfx.playSound('achievement', 2);
            showAchievementPopup2(achievement);
            this.savePlayerData();
        }

        savePlayerData() {
            localStorage.setItem('birdHunterProgress', JSON.stringify(playerProgress));
        }
    }

    const stats2 = new GameStatistics2();

    // æˆå°±å½ˆå‡ºå‡½æ•¸
    function showAchievementPopup2(achievement) {
        const popup = document.createElement('div');
        popup.style.cssText = `
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 3000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: achievementSlide2 0.5s ease-out;
        `;
        
        popup.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 2.5rem;">${achievement.icon}</div>
                <div>
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">æˆå°±è§£é–ï¼</div>
                    <div style="font-size: 1rem;">${achievement.name}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">${achievement.desc}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(popup);
        
        // è§¸è¦ºåé¥‹
        if (navigator.vibrate) {
            navigator.vibrate([20, 30, 20, 30, 20]);
        }
        
        setTimeout(() => {
            if (popup.parentNode) {
                popup.remove();
            }
        }, 4000);
    }

    // éŠæˆ²ç‹€æ…‹è®Šæ•¸
    let canvas, ctx;
    let currentLevelIdx = 0;
    let score = 0;
    let timeLeft = 0;
    let entities = []; // åŒ…å«é³¥å’Œç‚¸å½ˆ
    let clouds = []; // é›²æœµé™£åˆ—
    let particles = [];
    let gameInterval, spawnInterval;
    let isPlaying = false;
    let audioCtx;

    // --- å¢å¼·è²éŸ³ç³»çµ± ---
    class EnhancedSoundManager2 {
        constructor() {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.audioCtx.createGain();
            this.masterGain.gain.value = 0.3;
            this.masterGain.connect(this.audioCtx.destination);
            this.enabled = true;
        }
        
        resume() {
            if (this.audioCtx.state === 'suspended') {
                this.audioCtx.resume();
            }
        }
        
        playTone(freq, type, duration, vol = 0.1) {
            if (!this.enabled) return;
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, this.audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(this.masterGain);
            osc.start();
            osc.stop(this.audioCtx.currentTime + duration);
        }
        
        playSound(name, variations = 1) {
            const sounds = {
                shoot: { freq: 600, duration: 0.08, type: 'triangle', volume: 0.1 },
                hit: { freq: 800, duration: 0.1, type: 'sine', volume: 0.12 },
                bomb: { freq: 100, duration: 0.5, type: 'sawtooth', volume: 0.2 },
                win: { freq: 400, duration: 0.3, type: 'square', volume: 0.15 },
                achievement: { freq: 1200, duration: 0.4, type: 'sine', volume: 0.15 },
                button: { freq: 400, duration: 0.06, type: 'square', volume: 0.08 },
                levelComplete: { freq: 1000, duration: 0.2, type: 'triangle', volume: 0.12 }
            };
            
            const sound = sounds[name];
            if (!sound) return;
            
            this.resume();
            
            // æ·»åŠ éŸ³èª¿è®ŠåŒ–
            const pitch = 1 + (Math.random() - 0.5) * 0.1 * variations;
            this.playTone(sound.freq * pitch, sound.type, sound.duration, sound.volume);
            
            // ç‰¹æ®ŠéŸ³æ•ˆè™•ç†
            if (name === 'hit') {
                setTimeout(() => {
                    this.playTone(1200 * pitch, 'sine', 0.1, 0.08);
                }, 50);
            } else if (name === 'win') {
                [0, 200, 400].forEach((d, i) => {
                    setTimeout(() => {
                        this.playTone((400+i*200) * pitch, 'square', 0.2, 0.12);
                    }, d);
                });
            }
        }
        
        playComboSound(level) {
            // æ ¹æ“šé€£æ“Šç­‰ç´šæ’­æ”¾ä¸åŒéŸ³æ•ˆ
            const baseFreq = 300 + (level * 200);
            this.playTone(baseFreq, 'triangle', 0.15, 0.15);
            setTimeout(() => {
                this.playTone(baseFreq * 1.5, 'sine', 0.15, 0.12);
            }, 100);
        }
        
        setVolume(level) {
            this.masterGain.gain.value = Math.max(0, Math.min(1, level));
        }
        
        toggle() {
            this.enabled = !this.enabled;
            return this.enabled;
        }
    }
    
    const sfx = new EnhancedSoundManager2();
    
    // ä¿ç•™å…¼å®¹æ€§
    function initAudio() {
        sfx.resume();
    }

    const sounds = {
        shoot: () => { sfx.playSound('shoot'); },
        hit: () => { sfx.playSound('hit'); },
        bomb: () => { sfx.playSound('bomb'); },
        win: () => { sfx.playSound('win'); }
    };

    // --- é¡åˆ¥å®šç¾© ---
    class Entity {
        constructor(isBomb, lvlConfig) {
            this.isBomb = isBomb;
            this.size = lvlConfig.birdSize[0] + Math.random() * (lvlConfig.birdSize[1] - lvlConfig.birdSize[0]);
            this.y = Math.random() * (config.height - 100) + 20;
            this.speed = lvlConfig.birdSpeed[0] + Math.random() * (lvlConfig.birdSpeed[1] - lvlConfig.birdSpeed[0]);
            
            // æ–¹å‘
            this.direction = Math.random() > 0.5 ? 1 : -1;
            this.x = this.direction === 1 ? -this.size : config.width + this.size;

            // å¤–è§€
            this.color = isBomb ? '#333' : `hsl(${Math.random() * 360}, 70%, 60%)`;
            this.wingFlap = 0;
            this.dead = false;
        }

        update() {
            this.x += this.speed * this.direction;
            this.wingFlap += 0.3;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            if (this.direction === -1) ctx.scale(-1, 1);

            if (this.isBomb) {
                // ç‚¸å½ˆå¤–è§€ (é»‘è‰²åœ“çƒ + å°ç«ç´¢)
                ctx.fillStyle = '#111';
                ctx.beginPath();
                ctx.arc(0, 0, this.size/2, 0, Math.PI*2);
                ctx.fill();
                // éª·é«æ¨™èªŒ
                ctx.fillStyle = 'white';
                ctx.font = `${this.size/2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('â˜ ï¸', 0, 2);
                // ç«èŠ±
                if (Math.floor(Date.now() / 100) % 2 === 0) {
                    ctx.fillStyle = 'orange';
                    ctx.beginPath();
                    ctx.arc(-5, -this.size/2, 3, 0, Math.PI*2);
                    ctx.fill();
                }
            } else {
                // å°é³¥å¤–è§€
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size/2, this.size/2.5, 0, 0, Math.PI * 2);
                ctx.fill();
                // çœ¼ç›
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(this.size/4, -this.size/6, this.size/6, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(this.size/4 + 2, -this.size/6, this.size/12, 0, Math.PI*2);
                ctx.fill();
                // å˜´å·´
                ctx.fillStyle = '#FFA500';
                ctx.beginPath();
                ctx.moveTo(this.size/2.5, 0);
                ctx.lineTo(this.size/1.5, -this.size/10);
                ctx.lineTo(this.size/2.5, this.size/10);
                ctx.fill();
                // ç¿…è†€
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(-this.size/10, this.size/6 + Math.sin(this.wingFlap)*(this.size/5), this.size/2.5, this.size/5, -0.2, 0, Math.PI*2);
                ctx.fill();
            }
            ctx.restore();
        }

        checkClick(x, y) {
            const dist = Math.sqrt((this.x - x)**2 + (this.y - y)**2);
            return dist < this.size / 1.5;
        }

        isOffScreen() {
            return (this.direction === 1 && this.x > config.width + this.size) || 
                   (this.direction === -1 && this.x < -this.size);
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 3 + 1;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    // --- ç•Œé¢æ§åˆ¶ ---
    const screens = {
        home: document.getElementById('home-screen'),
        level: document.getElementById('level-screen'),
        game: document.getElementById('game-screen')
    };

    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[name].classList.add('active');
    }

    function showHome() { showScreen('home'); }
    function showLevelSelect() { 
        renderLevelGrid(); 
        showScreen('level'); 
    }

    function renderLevelGrid() {
        const grid = document.getElementById('levelGrid');
        grid.innerHTML = '';
        
        levels.forEach((lvl, idx) => {
            const card = document.createElement('div');
            const levelNum = idx + 1;
            const isUnlocked = levelNum <= playerProgress.maxUnlocked;
            
            card.className = `level-card ${!isUnlocked ? 'locked' : ''}`;
            card.setAttribute('role', 'gridcell');
            card.setAttribute('aria-label', `ç¬¬${levelNum}é—œ ${lvl.name}${isUnlocked ? '' : 'ï¼Œæœªè§£é–'}`);
            card.setAttribute('tabindex', isUnlocked ? '0' : '-1');
            
            if (!isUnlocked) {
                card.innerHTML = `<div class="lock-icon" aria-hidden="true">ğŸ”’</div>`;
            } else {
                const stars = playerProgress.levelStars[levelNum];
                let starHtml = '';
                for(let i=0; i<3; i++) {
                    const isEarned = i < stars;
                    starHtml += `<span class="star ${isEarned ? 'earned' : ''}" aria-label="${isEarned ? 'ç²å¾—çš„æ˜Ÿæ˜Ÿ' : 'æœªç²å¾—çš„æ˜Ÿæ˜Ÿ'}">â˜…</span>`;
                }
                card.innerHTML = `
                    <div class="level-num">ç¬¬ ${levelNum} é—œ</div>
                    <div style="font-size:0.9rem; color:#666">${lvl.name}</div>
                    <div class="level-stars" role="img" aria-label="å·²ç²å¾—${stars}é¡†æ˜Ÿ">${starHtml}</div>
                `;
                card.onclick = () => startGame(idx);
                
                // éµç›¤æ”¯æŒ
                card.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        startGame(idx);
                    }
                });
            }
            grid.appendChild(card);
        });
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function init() {
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        canvas.addEventListener('mousedown', handleClick);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            handleClick({ clientX: touch.clientX, clientY: touch.clientY });
        });
    }

    function initClouds() {
        clouds = [];
        for (let i = 0; i < 5; i++) {
            clouds.push({
                x: Math.random() * config.width,
                y: Math.random() * 80,
                size: 30 + Math.random() * 50,
                speed: 0.2 + Math.random() * 0.3
            });
        }
    }

    function startGame(levelIdx) {
        currentLevelIdx = levelIdx;
        score = 0;
        timeLeft = levels[levelIdx].time;
        entities = [];
        particles = [];
        initClouds(); // é‡æ–°ç”Ÿæˆé›²æœµ
        isPlaying = true;
        
        // é–‹å§‹çµ±è¨ˆ
        stats2.startGame();
        
        showScreen('game');
        updateHUD();
        updateStatsPanel();

        // å•Ÿå‹•å¾ªç’°
        clearInterval(gameInterval);
        clearInterval(spawnInterval);
        
        gameInterval = setInterval(() => {
            if(!isPlaying) return;
            timeLeft--;
            updateHUD();
            updateStatsPanel();
            if(timeLeft <= 0) endGame();
        }, 1000);

        const spawnRate = levels[levelIdx].spawnRate;
        spawnInterval = setInterval(() => {
            if(!isPlaying) return;
            const isBomb = Math.random() < levels[levelIdx].bombRate;
            entities.push(new Entity(isBomb, levels[levelIdx]));
        }, spawnRate);

        requestAnimationFrame(gameLoop);
    }

    function handleClick(e) {
        if (!isPlaying) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        let hit = false;
        // å€’åºæª¢æ¸¬ï¼ˆå„ªå…ˆé»åˆ°ä¸Šå±¤çš„ï¼‰
        for (let i = entities.length - 1; i >= 0; i--) {
            const ent = entities[i];
            if (ent.checkClick(x, y)) {
                hit = true;
                
                if (ent.isBomb) {
                    // é»åˆ°ç‚¸å½ˆ
                    sfx.playSound('bomb');
                    score -= 20;
                    stats2.recordHit(true, false); // ç‚¸å½ˆæ“Šä¸­
                    createExplosion(ent.x, ent.y, '#ff0000');
                    shakeScreen();
                    showFloatText(x, y, "-20", "red");
                    
                    // è§¸è¦ºåé¥‹
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                } else {
                    // é»åˆ°é³¥
                    sfx.playSound('hit');
                    score += 10;
                    stats2.recordHit(false, ent.color.includes('special')); // ç‰¹æ®Šé³¥æª¢æ¸¬
                    createExplosion(ent.x, ent.y, ent.color);
                    showFloatText(x, y, "+10", "gold");
                    
                    // é€£æ“ŠéŸ³æ•ˆ
                    if (playerProgress.statistics.currentCombo > 0 && playerProgress.statistics.currentCombo % 5 === 0) {
                        sfx.playComboSound(Math.floor(playerProgress.statistics.currentCombo / 5));
                        showComboIndicator(playerProgress.statistics.currentCombo);
                    }
                    
                    // è§¸è¦ºåé¥‹
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                }
                
                entities.splice(i, 1);
                updateHUD();
                break;
            }
        }

        if (!hit) {
            // ç©ºæ§
            sfx.playSound('shoot');
            stats2.recordMiss(); // è¨˜éŒ„å¤±èª¤
            
            // è¼•å¾®è§¸è¦ºåé¥‹
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }
    }

    // é€£æ“ŠæŒ‡ç¤ºå™¨
    function showComboIndicator(combo) {
        const existing = document.querySelector('.combo-indicator2');
        if (existing) existing.remove();
        
        const indicator = document.createElement('div');
        indicator.className = 'combo-indicator2';
        indicator.style.cssText = `
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            font-weight: bold;
            color: #FF6B35;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
            z-index: 1000;
            pointer-events: none;
            animation: comboGlow2 0.8s ease-out;
        `;
        indicator.textContent = `${combo} HIT COMBO!`;
        
        document.body.appendChild(indicator);
        setTimeout(() => indicator.remove(), 1500);
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<10; i++) particles.push(new Particle(x, y, color));
    }

    function showFloatText(x, y, text, color) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.textContent = text;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function shakeScreen() {
        document.body.classList.add('shake');
        setTimeout(() => document.body.classList.remove('shake'), 500);
    }

    function updateHUD() {
        document.getElementById('hudScore').textContent = `åˆ†æ•¸: ${score}`;
        document.getElementById('hudTimer').textContent = `${timeLeft}s`;
        document.getElementById('hudLevel').textContent = `ç¬¬ ${currentLevelIdx+1} é—œ`;
    }

    function updateStatsPanel() {
        document.getElementById('accuracyStat').textContent = `${playerProgress.statistics.averageAccuracy}%`;
        document.getElementById('comboStat').textContent = playerProgress.statistics.currentCombo;
        document.getElementById('bestComboStat').textContent = playerProgress.statistics.bestCombo;
    }

    function drawBackground() {
        // å¤©ç©º
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(0, 0, config.width, config.height);
        
        // é›²æœµ
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        clouds.forEach(cloud => {
            ctx.beginPath();
            ctx.arc(cloud.x, cloud.y, cloud.size * 0.5, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.size * 0.4, cloud.y - cloud.size * 0.15, cloud.size * 0.4, 0, Math.PI * 2);
            ctx.arc(cloud.x + cloud.size * 0.8, cloud.y, cloud.size * 0.5, 0, Math.PI * 2);
            ctx.fill();
            
            // ç§»å‹•é›²æœµ
            cloud.x += cloud.speed;
            if (cloud.x > config.width + 50) cloud.x = -50;
        });
        
        // è‰åœ°
        ctx.fillStyle = '#7CFC00';
        ctx.fillRect(0, config.height - 20, config.width, 20);
        // è‰åœ°è£é£¾
        ctx.fillStyle = '#66CD00';
        for(let i=0; i<config.width; i+=40) {
            ctx.beginPath();
            ctx.moveTo(i, config.height - 20);
            ctx.lineTo(i+10, config.height - 30);
            ctx.lineTo(i+20, config.height - 20);
            ctx.fill();
        }
    }

    function gameLoop() {
        if (!isPlaying) return;

        // ç¹ªè£½èƒŒæ™¯ (åŒ…å«é›²æœµ)
        drawBackground();

        // æ›´æ–°èˆ‡ç¹ªè£½å¯¦é«”
        for (let i = entities.length - 1; i >= 0; i--) {
            let ent = entities[i];
            ent.update();
            ent.draw(ctx);
            if (ent.isOffScreen()) {
                entities.splice(i, 1);
            }
        }

        // ç²’å­
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.update();
            p.draw(ctx);
            if (p.life <= 0) particles.splice(i, 1);
        }

        requestAnimationFrame(gameLoop);
    }

    function pauseGame() {
        if(!confirm("ç¢ºå®šè¦æ”¾æ£„æœ¬å±€ä¸¦é€€å‡ºå—ï¼Ÿ")) return;
        endGame(true);
    }

    function endGame(quit = false) {
        isPlaying = false;
        clearInterval(gameInterval);
        clearInterval(spawnInterval);

        const modal = document.getElementById('resultModal');
        const title = document.getElementById('resultTitle');
        const scoreText = document.getElementById('resultScore');
        const starsContainer = document.getElementById('resultStars');
        
        scoreText.textContent = `åˆ†æ•¸: ${score}`;
        
        // è¨ˆç®—æ˜Ÿæ˜Ÿ
        const lvlData = levels[currentLevelIdx];
        let starCount = 0;
        if (score >= lvlData.stars[2]) starCount = 3;
        else if (score >= lvlData.stars[1]) starCount = 2;
        else if (score >= lvlData.stars[0]) starCount = 1;

        // æª¢æŸ¥æ˜¯å¦å®Œç¾é—œå¡ï¼ˆç„¡å¤±èª¤ï¼‰
        const perfect = quit ? false : (stats2.sessionMisses === 0 && score > 0);

        if (quit) {
            title.textContent = "å·²é€€å‡º";
            starCount = 0;
        } else {
            title.textContent = starCount > 0 ? "æŒ‘æˆ°æˆåŠŸ!" : "å†æ¥å†å²!";
            sfx.playSound('win');
            
            if (perfect) {
                sfx.playSound('achievement');
                showFloatText(300, 200, "PERFECT!", "#FFD700");
            }
        }

        // çµ±è¨ˆéŠæˆ²çµæœ
        stats2.endGame(score, currentLevelIdx, perfect);

        // æ›´æ–°æ˜Ÿæ˜Ÿé¡¯ç¤º
        const starsDom = starsContainer.querySelectorAll('.star');
        starsDom.forEach((s, i) => {
            s.className = i < starCount ? 'star earned' : 'star';
        });

        // ä¿å­˜é€²åº¦
        if (!quit && starCount > 0) {
            if (starCount > playerProgress.levelStars[currentLevelIdx + 1]) {
                playerProgress.levelStars[currentLevelIdx + 1] = starCount;
            }
            if (currentLevelIdx + 1 < config.totalLevels && playerProgress.maxUnlocked <= currentLevelIdx + 1) {
                playerProgress.maxUnlocked = currentLevelIdx + 2;
            }
            localStorage.setItem('birdHunterProgress', JSON.stringify(playerProgress));
        }

        modal.style.display = 'block';
    }

    function restartLevel() {
        document.getElementById('resultModal').style.display = 'none';
        startGame(currentLevelIdx);
    }

    // å¯è¨ªå•æ€§ç®¡ç†å™¨
    class AccessibilityManager2 {
        constructor() {
            this.announcementQueue = [];
            this.isAnnouncing = false;
            this.init();
        }

        init() {
            this.setupKeyboardNavigation();
            this.setupCanvasKeyboardControl();
            this.showKeyboardHint();
        }

        setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                // æ•¸å­—éµå¿«é€Ÿé¸æ“‡é—œå¡
                if (screens.level.classList.contains('active')) {
                    if (e.key >= '1' && e.key <= '3') {
                        const levelIndex = parseInt(e.key) - 1;
                        if (levelIndex < levels.length && levelIndex < playerProgress.maxUnlocked) {
                            e.preventDefault();
                            startGame(levelIndex);
                        }
                    }
                }

                // éŠæˆ²ä¸­çš„éµç›¤æ§åˆ¶
                if (screens.game.classList.contains('active') && isPlaying) {
                    if (e.key === 'Escape' || e.key === 'p' || e.key === 'P') {
                        e.preventDefault();
                        this.announce('æš«åœéŠæˆ²');
                        pauseGame();
                    }
                    
                    // Tabéµå°èˆª
                    if (e.key === 'Tab') {
                        this.handleTabNavigation(e);
                    }
                }
            });
        }

        setupCanvasKeyboardControl() {
            const gameCanvas = document.getElementById('gameCanvas');
            
            gameCanvas.addEventListener('keydown', (e) => {
                if (!isPlaying) return;
                
                // ä½¿ç”¨éµç›¤æ¨¡æ“¬é»æ“Šå°„æ“Š
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    // åœ¨ç•«å¸ƒä¸­å¿ƒæ¨¡æ“¬é»æ“Š
                    const rect = gameCanvas.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    this.simulateClick(centerX, centerY);
                }
            });

            gameCanvas.addEventListener('focus', () => {
                if (isPlaying) {
                    this.announceGameState();
                }
            });
        }

        simulateClick(x, y) {
            const clickEvent = {
                clientX: x,
                clientY: y,
                preventDefault: () => {}
            };
            handleClick(clickEvent);
        }

        handleTabNavigation(e) {
            const focusableElements = document.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if(e.shiftKey) {
                if(document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                }
            } else {
                if(document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        }

        announce(message) {
            this.announcementQueue.push(message);
            if(!this.isAnnouncing) {
                this.processAnnouncementQueue();
            }
        }

        processAnnouncementQueue() {
            if(this.announcementQueue.length === 0) {
                this.isAnnouncing = false;
                return;
            }

            this.isAnnouncing = true;
            const message = this.announcementQueue.shift();
            
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                if(announcement.parentNode) {
                    document.body.removeChild(announcement);
                }
                this.processAnnouncementQueue();
            }, 100);
        }

        announceGameState() {
            if (isPlaying) {
                this.announce(`ç¬¬${currentLevelIdx + 1}é—œï¼Œå‰©é¤˜æ™‚é–“${timeLeft}ç§’ï¼Œç›®å‰åˆ†æ•¸${score}åˆ†`);
            }
        }

        announceHit(entity, points) {
            if (entity.isBomb) {
                this.announce('æ“Šä¸­ç‚¸å½ˆï¼Œæ‰£20åˆ†');
            } else {
                this.announce(`æ“Šä¸­å°é³¥ï¼ŒåŠ 10åˆ†`);
            }
        }

        showKeyboardHint() {
            const hint = document.createElement('div');
            hint.style.cssText = `
                position: fixed;
                bottom: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px;
                border-radius: 8px;
                font-size: 0.9rem;
                z-index: 1000;
                max-width: 300px;
            `;
            hint.innerHTML = `
                <strong>éµç›¤æ“ä½œï¼š</strong><br>
                â€¢ æ•¸å­—éµ1-3ï¼šå¿«é€Ÿé¸æ“‡é—œå¡<br>
                â€¢ Enter/ç©ºæ ¼ï¼šå°„æ“Šï¼ˆéŠæˆ²ä¸­ï¼‰<br>
                â€¢ Esc/Pï¼šæš«åœéŠæˆ²<br>
                â€¢ Tabï¼šå°èˆªç•Œé¢å…ƒç´ 
            `;
            document.body.appendChild(hint);
            
            setTimeout(() => {
                if(hint.parentNode) {
                    hint.remove();
                }
            }, 5000);
        }
    }

    // æˆå°±é¢æ¿åŠŸèƒ½
    function openAchievementsPanel2() {
        const existingPanel = document.getElementById('achievementsPanel2');
        if (existingPanel) {
            existingPanel.remove();
            return;
        }

        const panel = document.createElement('div');
        panel.id = 'achievementsPanel2';
        panel.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;

        const content = document.createElement('div');
        content.style.cssText = `
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #FFD700;
            color: white;
        `;

        content.innerHTML = `
            <h2 style="margin-bottom: 20px; text-align: center;">ğŸ† æˆå°±ç³»çµ±</h2>
            <button id="closeAchievements2" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
            <div class="achievements-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                ${Object.values(achievements2).map(achievement => {
                    const isUnlocked = playerProgress.achievements.includes(achievement.id);
                    return `
                        <div class="achievement-item ${isUnlocked ? 'unlocked' : ''}" style="
                            background: ${isUnlocked ? 'rgba(255, 215, 0, 0.2)' : 'rgba(255, 255, 255, 0.1)'};
                            border: 2px solid ${isUnlocked ? '#FFD700' : '#666'};
                            border-radius: 10px;
                            padding: 15px;
                            text-align: center;
                            transition: all 0.3s;
                        ">
                            <div style="font-size: 2rem; margin-bottom: 10px;">${isUnlocked ? achievement.icon : 'ğŸ”’'}</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">${achievement.name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">${achievement.desc}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;

        panel.appendChild(content);
        document.body.appendChild(panel);

        // äº‹ä»¶ç›£è½
        document.getElementById('closeAchievements2').onclick = () => {
            panel.remove();
            sfx.playSound('button');
        };

        panel.onclick = (e) => {
            if (e.target === panel) {
                panel.remove();
                sfx.playSound('button');
            }
        };

        sfx.playSound('button');
    }

    // è¨­ç½®æˆå°±æŒ‰éˆ•äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
        const achievementsBtn = document.getElementById('achievementsBtn2');
        if (achievementsBtn) {
            achievementsBtn.addEventListener('click', openAchievementsPanel2);
        }
    });

    // åˆå§‹åŒ–
    init();
    
    // åˆå§‹åŒ–å¯è¨ªå•æ€§ç®¡ç†å™¨
    window.accessibilityManager2 = new AccessibilityManager2();
    
    // å¢å¼·é»æ“Šè™•ç†ï¼Œæ·»åŠ å¯è¨ªå•æ€§å…¬å‘Š
    const originalHandleClick = handleClick;
    handleClick = function(e) {
        const prevScore = score;
        originalHandleClick(e);
        
        // å…¬å‘Šæ“Šä¸­çµæœ
        if (window.accessibilityManager2 && score !== prevScore) {
            const points = score - prevScore;
            if (points > 0) {
                window.accessibilityManager2.announceHit({ isBomb: false }, points);
            } else if (points < 0) {
                window.accessibilityManager2.announceHit({ isBomb: true }, points);
            }
        }
    };

</script>
</body>
</html>