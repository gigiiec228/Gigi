<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²ªé£Ÿè›‡ RPG - ç©å®¶ä¸»é ç‰ˆ</title>
    <!-- Accessibility improvements -->
    <meta name="description" content="è²ªé£Ÿè›‡RPGéŠæˆ²ï¼Œæ”¯æŒéµç›¤å’Œè§¸æ§æ“ä½œï¼ŒåŒ…å«ç©å®¶å®¢è£½åŒ–åŠŸèƒ½">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous">
    <style>
        :root {
            --primary: #4caf50;
            --accent: #ff9800;
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --border: #333;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        /* å®¹å™¨ */
        #main-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #000;
        }

        /* -----------------------
           å¤§å»³/ä¸»é æ¨£å¼
           ----------------------- */
        .lobby-screen {
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
            z-index: 20;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-header h1 {
            font-size: 2.5rem;
            margin: 10px 0;
            background: linear-gradient(90deg, var(--primary), #81c784);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .avatar-preview-box {
            width: 100px;
            height: 100px;
            background: #222;
            border-radius: 50%;
            border: 4px solid var(--primary);
            margin: 0 auto;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        
        .avatar-preview-box canvas {
            width: 100%;
            height: 100%;
        }

        /* é¸é …å¡ç‰‡ */
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .card h3 {
            margin-top: 0;
            color: var(--accent);
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group label {
            color: var(--text-muted);
        }

        input[type="text"] {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1rem;
            width: 60%;
        }

        input[type="color"] {
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            background: none;
        }

        /* é…ä»¶é¸æ“‡å™¨ */
        .accessory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .accessory-option {
            background: #333;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 24px;
        }

        .accessory-option:hover {
            background: #444;
        }

        .accessory-option.active {
            border-color: var(--accent);
            background: rgba(255, 152, 0, 0.1);
        }

        .btn-large {
            background: linear-gradient(to right, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            width: 100%;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: transform 0.1s;
        }

    .btn-large:active {
        transform: scale(0.98);
    }

    .btn-large,
    .accessory-option {
        position: relative;
        overflow: hidden;
    }

    .btn-large::after,
    .accessory-option::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
    }

    .btn-large:active::after,
    .accessory-option:active::after {
        width: 200px;
        height: 200px;
    }

        /* -----------------------
           éŠæˆ²ä»‹é¢æ¨£å¼
           ----------------------- */
        .game-interface {
            display: none; /* é è¨­éš±è— */
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        .hud-top {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: rgba(30, 30, 30, 0.8);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .hud-label { font-size: 0.8rem; color: #888; }
        .hud-value { font-size: 1.2rem; color: #fff; font-weight: bold; }

        canvas#gameCanvas {
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
        }

        /* æ¨¡æ…‹æ¡† (æš«åœ/çµæŸ) */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .hidden { display: none !important; }

        .btn {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-primary { background: var(--primary); border-color: var(--primary); }
        .btn-danger { background: #e53935; border-color: #e53935; }

        /* æ‰‹æ©Ÿæ§åˆ¶ */
        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(2, 60px);
            gap: 10px;
            margin-top: 15px;
        }
        .d-btn {
            background: #333; border: 1px solid #444; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #888; user-select: none;
        }
        .d-btn:active { background: #555; }
        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
            border-radius: 4px;
        }

        button:focus,
        input:focus,
        .accessory-option:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        /* æˆå°±ç³»çµ±æ¨£å¼ */
        .achievements-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .achievements-content {
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid var(--accent);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .achievement-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .achievement-item.unlocked {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent);
        }

        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .achievement-item-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .achievement-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-item-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .achievement-popup {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent), #FFD700);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 3000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: achievementSlide 0.5s ease-out;
        }

        @keyframes achievementSlide {
            0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .achievement-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .achievement-icon {
            font-size: 2.5rem;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .keyboard-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            max-width: 300px;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1001;
        }

        .skip-link:focus {
            top: 0;
        }

        /* è¦–è¦ºåé¥‹å¢å¼· */
        .combo-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 1000;
            pointer-events: none;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
        }

        .score-popup {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: scoreFloat 1s ease-out forwards;
        }

        @keyframes scoreFloat {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
        }

        @keyframes comboGlow {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        .pulse-effect {
            animation: pulse 0.3s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .shake-effect {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes ripple {
            to {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }

        /* å¾®äº¤äº’å¢å¼· */
        .interactive-element {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .interactive-element::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .interactive-element:active::before {
            width: 300px;
            height: 300px;
        }

        /* è¨­å®šé¢æ¿æ¨£å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        select {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1rem;
            width: 60%;
            cursor: pointer;
        }

        select:focus {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

    </style>
</head>
<body>
    <a href="#game-content" class="skip-link">è·³è‡³éŠæˆ²å…§å®¹</a>
    <div id="main-container" role="main">
        
        <!-- 1. ç©å®¶å¤§å»³ -->
        <div id="lobby" class="lobby-screen" role="region" aria-label="ç©å®¶è¨­å®šå¤§å»³">
            <div class="profile-header">
                <div class="avatar-preview-box" role="img" aria-label="ç©å®¶é ­åƒé è¦½">
                    <canvas id="avatarCanvas" width="100" height="100" aria-hidden="true"></canvas>
                </div>
                <h1>è²ªé£Ÿè›‡ RPG</h1>
                <p style="color:#888">æ‰“é€ ä½ çš„å°ˆå±¬æˆ°å ´é¢¨æ ¼</p>
            </div>

            <!-- åå­—è¨­å®š -->
            <div class="card">
                <h3>ç©å®¶è³‡æ–™</h3>
                <div class="input-group">
                    <label for="playerNameInput">æš±ç¨±</label>
                    <input type="text" id="playerNameInput" value="Player" maxlength="10" aria-describedby="name-help">
                </div>
            <div class="input-group">
                <label>æœ€é«˜åˆ†</label>
                <span id="lobbyHighScore" style="color: var(--primary); font-weight: bold;" aria-live="polite">0</span>
            </div>
            <div class="input-group">
                <label>ç¸½å ´æ¬¡</label>
                <span id="lobbyGamesPlayed" aria-live="polite">0</span>
            </div>
            <div id="name-help" class="sr-only">è¼¸å…¥æ‚¨çš„éŠæˆ²æš±ç¨±ï¼Œæœ€å¤š10å€‹å­—å…ƒ</div>
        </div>

        <!-- å¤–è§€è¨­å®š -->
        <div class="card">
            <h3>å¤–å‹å®¢è£½åŒ–</h3>
            <div class="input-group">
                <label for="colorHead">è›‡é ­é¡è‰²</label>
                <input type="color" id="colorHead" value="#4caf50" aria-describedby="color-head-help">
            </div>
            <div class="input-group">
                <label for="colorBody1">èº«é«”é¡è‰² (æ·±)</label>
                <input type="color" id="colorBody1" value="#2e7d32" aria-describedby="color-body-help">
            </div>
            <div class="input-group">
                <label for="colorBody2">èº«é«”é¡è‰² (æ·º)</label>
                <input type="color" id="colorBody2" value="#388e3c">
            </div>
            <div id="color-head-help" class="sr-only">é¸æ“‡è›‡é ­çš„é¡è‰²</div>
            <div id="color-body-help" class="sr-only">é¸æ“‡è›‡èº«é«”çš„é¡è‰²</div>
            
            <fieldset style="margin-top: 15px; border: none; padding: 0;">
                <legend style="display:block; margin-bottom:10px; color:var(--text-muted)">é¸æ“‡é…ä»¶</legend>
                <div class="accessory-grid" role="radiogroup" aria-label="è›‡é…ä»¶é¸æ“‡">
                    <button class="accessory-option active" data-acc="none" role="radio" aria-checked="true" aria-label="ç„¡é…ä»¶">ğŸš«</button>
                    <button class="accessory-option" data-acc="glasses" role="radio" aria-checked="false" aria-label="å¢¨é¡">ğŸ•¶ï¸</button>
                    <button class="accessory-option" data-acc="hat" role="radio" aria-checked="false" aria-label="ç¦®å¸½">ğŸ©</button>
                    <button class="accessory-option" data-acc="crown" role="radio" aria-checked="false" aria-label="çš‡å† ">ğŸ‘‘</button>
                </div>
            </fieldset>
        </div>

        <!-- éŠæˆ²è¨­å®š -->
        <div class="card">
            <h3>éŠæˆ²è¨­å®š</h3>
            <div class="input-group">
                <label for="soundToggle">éŸ³æ•ˆ</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="soundToggle" checked aria-describedby="sound-help">
                    <span class="toggle-slider"></span>
                </div>
            </div>
            <div class="input-group">
                <label for="hapticToggle">è§¸è¦ºåé¥‹</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="hapticToggle" checked aria-describedby="haptic-help">
                    <span class="toggle-slider"></span>
                </div>
            </div>
            <div class="input-group">
                <label for="difficultySelect">é›£åº¦</label>
                <select id="difficultySelect" aria-describedby="difficulty-help">
                    <option value="easy">ç°¡å–®</option>
                    <option value="normal" selected>æ™®é€š</option>
                    <option value="hard">å›°é›£</option>
                </select>
            </div>
            <div id="sound-help" class="sr-only">é–‹å•Ÿæˆ–é—œé–‰éŠæˆ²éŸ³æ•ˆ</div>
            <div id="haptic-help" class="sr-only">é–‹å•Ÿæˆ–é—œé–‰è§¸è¦ºåé¥‹ï¼ˆéœ‡å‹•ï¼‰</div>
            <div id="difficulty-help" class="sr-only">é¸æ“‡éŠæˆ²é›£åº¦ï¼šç°¡å–®ã€æ™®é€šæˆ–å›°é›£</div>
        </div>

        <button class="btn-large" id="startGameBtn" aria-label="é–‹å§‹è²ªé£Ÿè›‡éŠæˆ²">é–‹å§‹éŠæˆ²</button>
        <div style="margin-top:10px; color:#666; font-size:0.8rem;">è¨­å®šæœƒè‡ªå‹•ä¿å­˜</div>
    </div>

    <!-- 2. éŠæˆ²ä»‹é¢ -->
    <div id="gameInterface" class="game-interface" role="region" aria-label="éŠæˆ²ç•«é¢">
        <div class="hud-top" role="status" aria-live="polite">
            <div class="hud-item">
                <span class="hud-label">ç©å®¶</span>
                <span class="hud-value" id="gamePlayerName">Player</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">åˆ†æ•¸</span>
                <span class="hud-value" id="gameScore" aria-live="polite">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">é•·åº¦</span>
                <span class="hud-value" id="gameLength" aria-live="polite">3</span>
            </div>
        </div>

        <div id="game-content">
            <canvas id="gameCanvas" width="400" height="400" role="application" aria-label="è²ªé£Ÿè›‡éŠæˆ²ç•«å¸ƒï¼Œä½¿ç”¨æ–¹å‘éµæˆ–WASDæ§åˆ¶" tabindex="0"></canvas>
        </div>
        
        <div style="margin-top:5px; color:#888; font-size:0.8rem; display:flex; justify-content:center; gap:15px;">
            <span>ğŸ”´ æ™®é€š +10</span>
            <span>ğŸŒŸ é‡‘è˜‹æœ +20</span>
            <span>â˜ ï¸ æ¯’è˜‹æœ æ­»äº¡</span>
        </div>

        <div class="mobile-controls">
            <div class="d-btn up" data-dir="up">â–²</div>
            <div class="d-btn left" data-dir="left">â—€</div>
            <div class="d-btn down" data-dir="down">â–¼</div>
            <div class="d-btn right" data-dir="right">â–¶</div>
        </div>

        <!-- éŠæˆ²çµæŸ/æš«åœé®ç½© -->
        <div id="gameModal" class="modal-overlay hidden">
            <h2 id="modalTitle" style="color:white; font-size:2rem;">éŠæˆ²çµæŸ</h2>
            <p id="modalScore" style="color:#aaa; margin:10px 0;">åˆ†æ•¸: 0</p>
            <p id="modalReason" style="color:#ff5252; font-size:0.9rem;">æ’ç‰†äº†</p>
            <div style="margin-top:20px;">
                <button class="btn btn-primary" id="modalRestartBtn">é‡ç©</button>
                <button class="btn" id="modalHomeBtn">è¿”å›ä¸»é </button>
            </div>
            <button class="btn" id="modalPauseBtn" style="margin-top:10px; display:none;">ç¹¼çºŒéŠæˆ²</button>
        </div>
        
        <button id="miniPauseBtn" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); border:none; color:white; padding:5px; font-size:20px; cursor:pointer;">II</button>
        
        <!-- æˆå°±æŒ‰éˆ• -->
        <button id="achievementsBtn" style="position:absolute; top:10px; left:10px; background:rgba(255,215,0,0.8); border:none; color:rgba(0,0,0,0.8); padding:5px 10px; font-size:16px; border-radius:5px; cursor:pointer;" aria-label="æŸ¥çœ‹æˆå°±">
            ğŸ†
        </button>
    </div>

    <!-- æˆå°±é¢æ¿ -->
    <div id="achievementsPanel" class="achievements-panel hidden" role="dialog" aria-labelledby="achievements-title">
        <div class="achievements-content">
            <h2 id="achievements-title">ğŸ† æˆå°±ç³»çµ±</h2>
            <button id="closeAchievements" class="close-btn" aria-label="é—œé–‰æˆå°±é¢æ¿">Ã—</button>
            <div class="achievements-grid" id="achievementsGrid">
                <!-- å‹•æ…‹ç”Ÿæˆæˆå°±é …ç›® -->
            </div>
        </div>
    </div>

    <!-- æˆå°±å½ˆå‡ºé€šçŸ¥ -->
    <div id="achievementPopup" class="achievement-popup hidden">
        <div class="achievement-content">
            <div class="achievement-icon" id="achievementIcon"></div>
            <div class="achievement-info">
                <div class="achievement-title" id="achievementTitle"></div>
                <div class="achievement-desc" id="achievementDesc"></div>
            </div>
        </div>
    </div>

</div>

<script>
    /**
     * ç©å®¶è³‡æ–™ç®¡ç†ç³»çµ± - å¢å¼·ç‰ˆ
     */
    const defaultPlayer = {
        name: "SnakeLover",
        highScore: 0,
        gamesPlayed: 0,
        totalPlayTime: 0,
        skin: {
            head: "#4caf50",
            body1: "#2e7d32",
            body2: "#388e3c",
            accessory: "none"
        },
        statistics: {
            totalScore: 0,
            longestSnake: 3,
            foodEaten: { normal: 0, gold: 0, poison: 0 },
            gamesWon: 0,
            perfectGames: 0,
            averageScore: 0,
            lastPlayDate: null
        },
        achievements: [],
        settings: {
            soundEnabled: true,
            hapticEnabled: true,
            difficulty: 'normal'
        }
    };

    let player = JSON.parse(localStorage.getItem('snakeRPG_Player')) || defaultPlayer;

    // æˆå°±ç³»çµ±
    const achievements = {
        firstWin: { id: 'firstWin', name: 'åˆæ¬¡å‹åˆ©', desc: 'å®Œæˆç¬¬ä¸€å ´éŠæˆ²', icon: 'ğŸ®' },
        speedRunner: { id: 'speedRunner', name: 'é–ƒé›»ä¿ ', desc: '30ç§’å…§é”åˆ°50åˆ†', icon: 'âš¡' },
        goldCollector: { id: 'goldCollector', name: 'é»ƒé‡‘æ”¶è—å®¶', desc: 'ç´¯è¨ˆåƒæ‰10å€‹é‡‘è˜‹æœ', icon: 'ğŸ’°' },
        snakeMaster: { id: 'snakeMaster', name: 'è²ªé£Ÿè›‡å¤§å¸«', desc: 'è›‡èº«é•·åº¦é”åˆ°20', icon: 'ğŸ' },
        perfectionist: { id: 'perfectionist', name: 'å®Œç¾ä¸»ç¾©', desc: 'ç„¡æ­»äº¡å®Œæˆ5å ´éŠæˆ²', icon: 'ğŸ’' },
        veteran: { id: 'veteran', name: 'è€ç©å®¶', desc: 'å®Œæˆ50å ´éŠæˆ²', icon: 'ğŸ†' }
    };

    // éŠæˆ²çµ±è¨ˆç®¡ç†å™¨
    class GameStatistics {
        constructor() {
            this.sessionStartTime = Date.now();
            this.currentGameStartTime = null;
        }

        startGame() {
            this.currentGameStartTime = Date.now();
        }

        endGame(finalScore, snakeLength, gameOverReason) {
            if (!this.currentGameStartTime) return;

            const gameDuration = Date.now() - this.currentGameStartTime;
            
            // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            player.statistics.totalScore += finalScore;
            player.statistics.totalPlayTime += gameDuration;
            player.statistics.gamesPlayed++;
            
            if (snakeLength > player.statistics.longestSnake) {
                player.statistics.longestSnake = snakeLength;
            }
            
            if (finalScore > 0) {
                player.statistics.gamesWon++;
            }
            
            // è¨ˆç®—å¹³å‡åˆ†æ•¸
            player.statistics.averageScore = Math.round(player.statistics.totalScore / player.statistics.gamesPlayed);
            
            // è¨˜éŒ„æœ€å¾ŒéŠæˆ²æ™‚é–“
            player.statistics.lastPlayDate = new Date().toISOString();
            
            // ä¿å­˜æ•¸æ“š
            this.savePlayerData();
            
            // æª¢æŸ¥æˆå°±
            this.checkAchievements(finalScore, snakeLength, gameDuration);
        }

        recordFood(type) {
            if (player.statistics.foodEaten[type] !== undefined) {
                player.statistics.foodEaten[type]++;
            }
        }

        checkAchievements(score, snakeLength, duration) {
            const newAchievements = [];

            // é¦–æ¬¡å‹åˆ©
            if (score > 0 && !this.hasAchievement('firstWin')) {
                newAchievements.push(achievements.firstWin);
            }

            // é–ƒé›»ä¿ 
            if (duration < 30000 && score >= 50 && !this.hasAchievement('speedRunner')) {
                newAchievements.push(achievements.speedRunner);
            }

            // é»ƒé‡‘æ”¶è—å®¶
            if (player.statistics.foodEaten.gold >= 10 && !this.hasAchievement('goldCollector')) {
                newAchievements.push(achievements.goldCollector);
            }

            // è²ªé£Ÿè›‡å¤§å¸«
            if (snakeLength >= 20 && !this.hasAchievement('snakeMaster')) {
                newAchievements.push(achievements.snakeMaster);
            }

            // è€ç©å®¶
            if (player.statistics.gamesPlayed >= 50 && !this.hasAchievement('veteran')) {
                newAchievements.push(achievements.veteran);
            }

            // é¡¯ç¤ºæ–°æˆå°±
            newAchievements.forEach(achievement => {
                this.unlockAchievement(achievement);
            });
        }

        hasAchievement(id) {
            return player.achievements.includes(id);
        }

        unlockAchievement(achievement) {
            player.achievements.push(achievement.id);
            sfx.playSound('achievement', 2);
            showAchievementPopup(achievement);
            this.savePlayerData();
        }

        savePlayerData() {
            localStorage.setItem('snakeRPG_Player', JSON.stringify(player));
        }
    }

    const stats = new GameStatistics();
    
    // DOM å…ƒç´ 
    const dom = {
        lobby: document.getElementById('lobby'),
        gameInterface: document.getElementById('gameInterface'),
        inputs: {
            name: document.getElementById('playerNameInput'),
            head: document.getElementById('colorHead'),
            body1: document.getElementById('colorBody1'),
            body2: document.getElementById('colorBody2'),
            sound: document.getElementById('soundToggle'),
            haptic: document.getElementById('hapticToggle'),
            difficulty: document.getElementById('difficultySelect')
        },
        display: {
            highScore: document.getElementById('lobbyHighScore'),
            gamesPlayed: document.getElementById('lobbyGamesPlayed'),
            gamePlayerName: document.getElementById('gamePlayerName'),
            gameScore: document.getElementById('gameScore'),
            gameLength: document.getElementById('gameLength'),
            modalTitle: document.getElementById('modalTitle'),
            modalScore: document.getElementById('modalScore'),
            modalReason: document.getElementById('modalReason'),
            modal: document.getElementById('gameModal')
        },
        avatarCanvas: document.getElementById('avatarCanvas'),
        gameCanvas: document.getElementById('gameCanvas')
    };

    // åˆå§‹åŒ–å¤§å»³è³‡æ–™
    function initLobby() {
        dom.inputs.name.value = player.name;
        dom.inputs.head.value = player.skin.head;
        dom.inputs.body1.value = player.skin.body1;
        dom.inputs.body2.value = player.skin.body2;
        
        // è¼‰å…¥è¨­å®š
        dom.inputs.sound.checked = player.settings.soundEnabled;
        dom.inputs.haptic.checked = player.settings.hapticEnabled;
        dom.inputs.difficulty.value = player.settings.difficulty;
        
        dom.display.highScore.textContent = player.highScore;
        dom.display.gamesPlayed.textContent = player.gamesPlayed;

        // è¨­å®šé…ä»¶é¸å–ç‹€æ…‹
        document.querySelectorAll('.accessory-option').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.acc === player.skin.accessory) {
                el.classList.add('active');
            }
        });

        updateAvatarPreview();
    }

    // å„²å­˜è³‡æ–™
    function savePlayer() {
        player.name = dom.inputs.name.value || "Anonymous";
        player.skin.head = dom.inputs.head.value;
        player.skin.body1 = dom.inputs.body1.value;
        player.skin.body2 = dom.inputs.body2.value;
        
        // å„²å­˜è¨­å®š
        player.settings.soundEnabled = dom.inputs.sound.checked;
        player.settings.hapticEnabled = dom.inputs.haptic.checked;
        player.settings.difficulty = dom.inputs.difficulty.value;
        
        // æ‡‰ç”¨è¨­å®šåˆ°ç®¡ç†å™¨
        if (sfx) {
            sfx.enabled = player.settings.soundEnabled;
        }
        if (haptic) {
            haptic.enabled = player.settings.hapticEnabled;
        }
        
        localStorage.setItem('snakeRPG_Player', JSON.stringify(player));
        dom.display.highScore.textContent = player.highScore;
        updateAvatarPreview();
    }

    // äº‹ä»¶ç›£è½ï¼šè¼¸å…¥è®ŠåŒ–æ™‚å³æ™‚æ›´æ–°
    Object.values(dom.inputs).forEach(input => {
        if (input.type === 'checkbox' || input.tagName === 'SELECT') {
            input.addEventListener('change', savePlayer);
        } else {
            input.addEventListener('input', savePlayer);
        }
    });

    // äº‹ä»¶ç›£è½ï¼šé…ä»¶é¸æ“‡
    document.querySelectorAll('.accessory-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.accessory-option').forEach(opt => {
                opt.classList.remove('active');
                opt.setAttribute('aria-checked', 'false');
            });
            el.classList.add('active');
            el.setAttribute('aria-checked', 'true');
            player.skin.accessory = el.dataset.acc;
            savePlayer();
            
            // å¯è¨ªå•æ€§å…¬å‘Š
            if(window.accessibilityManager) {
                const accessoryName = el.getAttribute('aria-label');
                window.accessibilityManager.announce(`å·²é¸æ“‡ ${accessoryName}`);
            }
        });
    });

    // ç¹ªè£½å¤§å»³é ­åƒé è¦½
    function updateAvatarPreview() {
        const ctx = dom.avatarCanvas.getContext('2d');
        const s = 100;
        ctx.clearRect(0,0,s,s);
        
        // èº«é«”
        ctx.fillStyle = player.skin.body1;
        ctx.fillRect(20, 50, 60, 40);
        ctx.fillStyle = player.skin.body2;
        ctx.fillRect(20, 70, 60, 20);
        
        // é ­
        ctx.fillStyle = player.skin.head;
        ctx.beginPath();
        ctx.arc(50, 40, 25, 0, Math.PI*2);
        ctx.fill();
        
        // çœ¼ç›
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(40, 35, 6, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(60, 35, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(42, 35, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(58, 35, 2, 0, Math.PI*2); ctx.fill();

        // é…ä»¶é è¦½
        drawAccessory(ctx, 50, 40, 25, 'right', player.skin.accessory);
    }

    /* ----------------------------------------
       éŠæˆ²æ ¸å¿ƒé‚è¼¯
       ---------------------------------------- */
    const canvas = dom.gameCanvas;
    const ctx = canvas.getContext('2d');
    
    let snake = [];
    let food = { x:0, y:0, type:'normal' };
    let direction = 'right';
    let nextDirection = 'right';
    let score = 0;
    let gameSpeed = 130;
    let isPaused = false;
    let isGameOver = false;
    let isPlaying = false; // æ–°å¢ï¼šéŠæˆ²é€²è¡Œä¸­ç‹€æ…‹
    let gameLoopId;
    let lastTime = 0;

    // å¢å¼·éŸ³æ•ˆç³»çµ±
    class EnhancedSoundManager {
        constructor() {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.audioContext.createGain();
            this.masterGain.gain.value = 0.4;
            this.masterGain.connect(this.audioContext.destination);
            this.enabled = true;
            
            this.sounds = {
                move: { freq: 200, duration: 0.05, type: 'sine', volume: 0.05 },
                eat: { freq: 600, duration: 0.1, type: 'sine', volume: 0.1 },
                gold: { freq: 1200, duration: 0.2, type: 'square', volume: 0.12 },
                die: { freq: 100, duration: 0.3, type: 'sawtooth', volume: 0.2 },
                powerUp: { freq: 1600, duration: 0.25, type: 'triangle', volume: 0.15 },
                achievement: { freq: 800, duration: 0.4, type: 'sine', volume: 0.15 },
                button: { freq: 400, duration: 0.08, type: 'square', volume: 0.06 },
                pause: { freq: 300, duration: 0.15, type: 'triangle', volume: 0.08 }
            };
        }
        
        resume() {
            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }
        }
        
        playSound(name, variations = 1) {
            if (!this.enabled || !this.sounds[name]) return;
            
            this.resume();
            const sound = this.sounds[name];
            
            // æ·»åŠ éŸ³èª¿è®ŠåŒ–
            const pitch = 1 + (Math.random() - 0.5) * 0.1 * variations;
            this.playTone(sound.freq * pitch, sound.type, sound.duration, sound.volume);
            
            // æ·»åŠ å’ŒéŸ³æ•ˆæœï¼ˆæŸäº›éŸ³æ•ˆï¼‰
            if (name === 'achievement' || name === 'powerUp') {
                setTimeout(() => {
                    this.playTone(sound.freq * 1.5, 'sine', sound.duration * 0.6, sound.volume * 0.7);
                }, 50);
            }
        }
        
        playTone(freq, type, duration, vol = 0.1) {
            const osc = this.audioContext.createOscillator();
            const gain = this.audioContext.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.audioContext.currentTime);
            
            gain.gain.setValueAtTime(vol, this.audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(this.masterGain);
            
            osc.start(this.audioContext.currentTime);
            osc.stop(this.audioContext.currentTime + duration);
        }
        
        playMoveSequence(direction) {
            // æ–¹å‘ç§»å‹•éŸ³æ•ˆåºåˆ—
            const baseFreq = 250;
            const directionMultiplier = {
                'up': 1.2,
                'down': 0.8,
                'left': 0.9,
                'right': 1.1
            };
            
            this.playTone(baseFreq * directionMultiplier[direction], 'sine', 0.03, 0.04);
            setTimeout(() => {
                this.playTone(baseFreq * directionMultiplier[direction] * 1.1, 'sine', 0.03, 0.04);
            }, 30);
        }
        
        setVolume(level) {
            this.masterGain.gain.value = Math.max(0, Math.min(1, level));
        }
        
        toggle() {
            this.enabled = !this.enabled;
            return this.enabled;
        }
    }
    
    const sfx = new EnhancedSoundManager();
    
    // ä¿ç•™åŸå‡½æ•¸ä»¥å…¼å®¹ç¾æœ‰ä»£ç¢¼
    function playSound(type) {
        sfx.playSound(type);
    }

    // è§¸è¦ºåé¥‹ç®¡ç†å™¨
    class HapticFeedbackManager {
        constructor() {
            this.enabled = true;
            this.vibrationPatterns = {
                move: [50],
                eat: [100, 50, 100],
                gold: [200, 100, 200],
                die: [300, 100, 300, 100, 300],
                error: [400, 200, 400],
                success: [100, 50, 100, 50, 100],
                achievement: [150, 100, 150, 100, 150]
            };
        }
        
        provideFeedback(type) {
            if (!this.enabled || !navigator.vibrate) return;
            
            const pattern = this.vibrationPatterns[type] || [100];
            navigator.vibrate(pattern);
        }
        
        toggle() {
            this.enabled = !this.enabled;
            return this.enabled;
        }
    }

    // å¾®äº¤äº’ç®¡ç†å™¨
    class MicroInteractionsManager {
        constructor() {
            this.setupButtonEffects();
            this.setupInputFeedback();
        }
        
        setupButtonEffects() {
            document.querySelectorAll('button, .accessory-option, .d-btn').forEach(element => {
                element.addEventListener('click', (e) => {
                    this.addClickEffect(e);
                });
                
                element.addEventListener('mouseenter', () => {
                    this.addHoverEffect(element);
                });
                
                element.addEventListener('mouseleave', () => {
                    this.removeHoverEffect(element);
                });
            });
        }
        
        setupInputFeedback() {
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('focus', () => {
                    input.classList.add('pulse-effect');
                });
                
                input.addEventListener('blur', () => {
                    input.classList.remove('pulse-effect');
                });
                
                input.addEventListener('input', () => {
                    sfx.playSound('move');
                });
            });
        }
        
        addClickEffect(e) {
            const ripple = document.createElement('span');
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                width: 20px;
                height: 20px;
                pointer-events: none;
                transform: translate(-50%, -50%) scale(0);
                animation: ripple 0.6s ease-out;
            `;
            
            const rect = e.currentTarget.getBoundingClientRect();
            ripple.style.left = (e.clientX - rect.left) + 'px';
            ripple.style.top = (e.clientY - rect.top) + 'px';
            
            e.currentTarget.style.position = 'relative';
            e.currentTarget.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 600);
        }
        
        addHoverEffect(element) {
            element.style.transform = 'scale(1.05)';
            element.style.transition = 'transform 0.2s';
        }
        
        removeHoverEffect(element) {
            element.style.transform = 'scale(1)';
        }
        
        showScorePopup(points, x, y) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = (points > 0 ? '+' : '') + points;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.style.color = points > 0 ? '#4caf50' : '#ff5252';
            
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }
        
        showComboIndicator(combo) {
            const existing = document.querySelector('.combo-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'combo-indicator';
            indicator.textContent = combo > 3 ? 'SUPER COMBO!' : `COMBO x${combo}`;
            
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 1500);
        }
    }

    // åˆ‡æ›ç•«é¢
    document.getElementById('startGameBtn').addEventListener('click', () => {
        dom.lobby.style.display = 'none';
        dom.gameInterface.style.display = 'flex';
        dom.display.gamePlayerName.textContent = player.name;
        initGame();
    });

    document.getElementById('modalHomeBtn').addEventListener('click', () => {
        dom.gameInterface.style.display = 'none';
        dom.lobby.style.display = 'flex';
        initLobby(); // åˆ·æ–°è³‡æ–™
    });

    document.getElementById('modalRestartBtn').addEventListener('click', () => {
        dom.display.modal.classList.add('hidden');
        initGame();
    });

    document.getElementById('modalPauseBtn').addEventListener('click', togglePause);
    document.getElementById('miniPauseBtn').addEventListener('click', togglePause);

    function initGame() {
        snake = [{x:10,y:10}, {x:9,y:10}, {x:8,y:10}];
        score = 0;
        direction = 'right';
        nextDirection = 'right';
        gameSpeed = 130;
        isGameOver = false;
        isPaused = false;
        isPlaying = true; // è¨­ç½®éŠæˆ²é€²è¡Œä¸­
        
        // é–‹å§‹çµ±è¨ˆ
        stats.startGame();
        
        spawnFood();
        updateGameUI();
        
        dom.display.modal.classList.add('hidden');
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    function spawnFood() {
        let valid = false;
        while(!valid) {
            food.x = Math.floor(Math.random() * (canvas.width/20));
            food.y = Math.floor(Math.random() * (canvas.height/20));
            valid = !snake.some(s => s.x===food.x && s.y===food.y);
        }
        const r = Math.random();
        food.type = r < 0.05 ? 'poison' : (r < 0.15 ? 'gold' : 'normal');
    }

    function togglePause() {
        if(isGameOver) return;
        isPaused = !isPaused;
        if(isPaused) {
            dom.display.modalTitle.textContent = "å·²æš«åœ";
            dom.display.modalScore.textContent = `ç›®å‰åˆ†æ•¸: ${score}`;
            dom.display.modalReason.textContent = "";
            dom.display.modal.classList.remove('hidden');
            document.getElementById('modalRestartBtn').style.display = 'none';
            document.getElementById('modalHomeBtn').style.display = 'inline-block';
            document.getElementById('modalPauseBtn').style.display = 'inline-block';
            document.getElementById('modalPauseBtn').textContent = "ç¹¼çºŒéŠæˆ²";
            
            // å¯è¨ªå•æ€§å…¬å‘Š
            if(window.accessibilityManager) {
                window.accessibilityManager.announce(`éŠæˆ²å·²æš«åœï¼Œç›®å‰åˆ†æ•¸ ${score} åˆ†`);
            }
        } else {
            dom.display.modal.classList.add('hidden');
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            
            // å¯è¨ªå•æ€§å…¬å‘Š
            if(window.accessibilityManager) {
                window.accessibilityManager.announce('éŠæˆ²å·²ç¹¼çºŒ');
            }
        }
    }

    function gameLoop(timestamp) {
        if(isPaused || isGameOver) return;
        if(timestamp - lastTime > gameSpeed) {
            update();
            lastTime = timestamp;
        }
        draw();
        if(!isPaused && !isGameOver) requestAnimationFrame(gameLoop);
    }

    function update() {
        direction = nextDirection;
        const head = {...snake[0]};
        if(direction==='right') head.x++;
        if(direction==='left') head.x--;
        if(direction==='up') head.y--;
        if(direction==='down') head.y++;

        const gw = canvas.width/20;
        const gh = canvas.height/20;

        // æ­»äº¡åˆ¤å®š
        if(head.x<0 || head.x>=gw || head.y<0 || head.y>=gh || snake.some(s=>s.x===head.x && s.y===head.y)) {
            gameOver("ä½ æ’è»Šäº†ï¼");
            return;
        }

        snake.unshift(head);

        // åƒé£Ÿç‰©
        if(head.x===food.x && head.y===food.y) {
            if(food.type === 'poison') {
                stats.recordFood('poison');
                gameOver("ä¸­æ¯’èº«äº¡ï¼");
                return;
            }
            const points = food.type === 'gold' ? 20 : 10;
            score += points;
            
            // è¨˜éŒ„é£Ÿç‰©çµ±è¨ˆ
            stats.recordFood(food.type);
            
            if(food.type === 'gold') {
                gameSpeed = Math.max(60, gameSpeed - 3);
                microInteractions.showScorePopup(points, head.x * 20, head.y * 20);
            } else {
                microInteractions.showScorePopup(points, head.x * 20, head.y * 20);
            }
            
            playSound(food.type === 'gold' ? 'gold' : 'eat');
            haptic.provideFeedback(food.type === 'gold' ? 'success' : 'eat');
            spawnFood();
        } else {
            snake.pop();
        }
        updateGameUI();
    }

    function gameOver(reason) {
        isGameOver = true;
        isPlaying = false; // è¨­ç½®éŠæˆ²çµæŸ
        playSound('die');
        haptic.provideFeedback('error');
        
        // çµæŸçµ±è¨ˆ
        stats.endGame(score, snake.length, reason);
        
        // æ·»åŠ éœ‡å‹•æ•ˆæœ
        document.body.classList.add('shake-effect');
        setTimeout(() => {
            document.body.classList.remove('shake-effect');
        }, 500);

        // é¡¯ç¤ºçµç®—
        dom.display.modalTitle.textContent = "éŠæˆ²çµæŸ";
        dom.display.modalScore.textContent = `æœ€çµ‚åˆ†æ•¸: ${score}`;
        dom.display.modalReason.textContent = reason;
        dom.display.modal.classList.remove('hidden');
        document.getElementById('modalRestartBtn').style.display = 'inline-block';
        document.getElementById('modalHomeBtn').style.display = 'inline-block';
        document.getElementById('modalPauseBtn').style.display = 'none';
        
        // å¯è¨ªå•æ€§å…¬å‘Š
        if(window.accessibilityManager) {
            window.accessibilityManager.announce(`éŠæˆ²çµæŸï¼Œ${reason}ï¼Œæœ€çµ‚åˆ†æ•¸ ${score} åˆ†`);
        }
    }

    function updateGameUI() {
        const oldScore = parseInt(dom.display.gameScore.textContent);
        const oldLength = parseInt(dom.display.gameLength.textContent);
        
        dom.display.gameScore.textContent = score;
        dom.display.gameLength.textContent = snake.length;
        
        // å¯è¨ªå•æ€§ï¼šåˆ†æ•¸è®ŠåŒ–å…¬å‘Š
        if(window.accessibilityManager && isPlaying && !isPaused) {
            if(score > oldScore) {
                const points = score - oldScore;
                window.accessibilityManager.announce(`ç²å¾— ${points} åˆ†ï¼Œç¸½åˆ† ${score}`);
            }
            if(snake.length > oldLength) {
                window.accessibilityManager.announce(`è›‡èº«é•·åº¦å¢åŠ åˆ° ${snake.length}`);
            }
        }
    }

    /* -----------------------
       ç¹ªåœ–ç³»çµ± (æ”¯æ´å¤–å‹èˆ‡é…ä»¶)
       ----------------------- */
    function draw() {
        // èƒŒæ™¯
        ctx.fillStyle = "#050505";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        
        // ç¶²æ ¼
        ctx.strokeStyle = "#1a1a1a";
        ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=20) {
            ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke();
        }
        for(let i=0; i<canvas.height; i+=20) {
            ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke();
        }

        // é£Ÿç‰©
        const fx = food.x*20 + 10;
        const fy = food.y*20 + 10;
        ctx.fillStyle = food.type==='normal'?'#ff5252' : (food.type==='gold'?'#ffd700':'#9c27b0');
        if(food.type==='gold') ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
        ctx.beginPath(); ctx.arc(fx, fy, 8, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur=0;

        // è›‡
        snake.forEach((seg, i) => {
            const isHead = i===0;
            const x = seg.x * 20;
            const y = seg.y * 20;
            
            ctx.fillStyle = (i%2===0) ? player.skin.body1 : player.skin.body2;
            if(isHead) ctx.fillStyle = player.skin.head;
            
            // åœ“è§’
            ctx.beginPath();
            const r = isHead ? 8 : 4;
            ctx.roundRect(x+1, y+1, 18, 18, r);
            ctx.fill();

            if(isHead) {
                // çœ¼ç›
                ctx.fillStyle = "white";
                let ex = x+10, ey = y+10;
                let off = 0;
                if(direction==='right') off=4;
                if(direction==='left') off=-4;
                if(direction==='down') off=4; // yè»¸åç§»ç°¡åŒ–è™•ç†ï¼Œåªåšxè»¸æ˜é¡¯é»
                // é€™è£¡ç°¡åŒ–çœ¼ç›ä½ç½®ï¼Œä¸éš¨æ—‹è½‰è¤‡é›œè¨ˆç®—ï¼Œåƒ…ç¤ºæ„
                let eyeX1 = (direction==='right'?14 : (direction==='left'?6 : 6));
                let eyeY1 = (direction==='down'?14 : 6);
                
                ctx.beginPath(); ctx.arc(x+eyeX1, y+eyeY1, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(x+eyeX1+1, y+eyeY1, 1, 0, Math.PI*2); ctx.fill();

                // ç¹ªè£½é…ä»¶
                drawAccessory(ctx, x+10, y+10, 10, direction, player.skin.accessory);
            }
        });
    }

    // é…ä»¶ç¹ªè£½é‚è¼¯
    function drawAccessory(ctx, cx, cy, r, dir, type) {
        ctx.save();
        ctx.translate(cx, cy);
        
        // æ ¹æ“šæ–¹å‘æ—‹è½‰ç•«å¸ƒ
        let angle = 0;
        if(dir==='right') angle = 0;
        if(dir==='down') angle = Math.PI/2;
        if(dir==='left') angle = Math.PI;
        if(dir==='up') angle = -Math.PI/2;
        ctx.rotate(angle);

        if(type === 'glasses') {
            ctx.fillStyle = "black";
            ctx.fillRect(0, -6, 12, 6); // é¡æ¡†
            ctx.fillRect(-8, -6, 6, 6); 
            ctx.fillRect(0, -3, 4, 1); // é¼»æ¨‘
        } else if(type === 'hat') {
            ctx.fillStyle = "#222";
            ctx.fillRect(-8, -12, 16, 12); // å¸½èº«
            ctx.fillStyle = "#333";
            ctx.fillRect(-12, 0, 24, 3); // å¸½ç°·
            ctx.fillStyle = "#d32f2f";
            ctx.fillRect(-4, -14, 8, 2); // è£é£¾å¸¶
        } else if(type === 'crown') {
            ctx.fillStyle = "#ffd700";
            ctx.beginPath();
            ctx.moveTo(-8, -2);
            ctx.lineTo(-6, -12); ctx.lineTo(0, -6);
            ctx.lineTo(6, -12); ctx.lineTo(8, -2);
            ctx.fill();
            ctx.fillStyle = "#ffeb3b";
            ctx.beginPath(); ctx.arc(0, -9, 2, 0, Math.PI*2); ctx.fill();
        }

        ctx.restore();
    }

    // å¯è¨ªå•æ€§å¢å¼·ï¼šéµç›¤å°èˆªå’Œå±å¹•é–±è®€å™¨æ”¯æŒ
    class AccessibilityManager {
        constructor() {
            this.announcementQueue = [];
            this.isAnnouncing = false;
            this.init();
        }

        init() {
            this.setupKeyboardNavigation();
            this.setupScreenReaderSupport();
            this.setupFocusManagement();
            this.showKeyboardHint();
        }

        setupKeyboardNavigation() {
            // å¢å¼·çš„éµç›¤æ§åˆ¶
            document.addEventListener('keydown', (e) => {
                const key = e.key;
                
                // åœ¨éŠæˆ²ç•«é¢æ™‚
                if (dom.gameInterface.style.display !== 'none') {
                    if(['ArrowUp','w','W'].includes(key) && direction!=='down') {
                        e.preventDefault();
                        nextDirection='up';
                        this.announceDirection('ä¸Š');
                    }
                    if(['ArrowDown','s','S'].includes(key) && direction!=='up') {
                        e.preventDefault();
                        nextDirection='down';
                        this.announceDirection('ä¸‹');
                    }
                    if(['ArrowLeft','a','A'].includes(key) && direction!=='right') {
                        e.preventDefault();
                        nextDirection='left';
                        this.announceDirection('å·¦');
                    }
                    if(['ArrowRight','d','D'].includes(key) && direction!=='left') {
                        e.preventDefault();
                        nextDirection='right';
                        this.announceDirection('å³');
                    }
                    
                    // ç©ºæ ¼éµæš«åœ
                    if(key === ' ' || key === 'Escape') {
                        e.preventDefault();
                        togglePause();
                    }
                }
                
                // Tabéµå°èˆª
                if(key === 'Tab') {
                    this.handleTabNavigation(e);
                }
            });
        }

        setupScreenReaderSupport() {
            // ç‚ºé…ä»¶é¸æ“‡æ·»åŠ éµç›¤æ”¯æŒ
            document.querySelectorAll('.accessory-option').forEach(btn => {
                btn.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.selectAccessory(btn);
                    }
                    
                    // æ–¹å‘éµåœ¨é…ä»¶çµ„ä¸­å°èˆª
                    if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        this.navigateAccessories(e.key === 'ArrowLeft' ? -1 : 1);
                    }
                });
            });

            // ç‚ºç§»å‹•æŒ‰éˆ•æ·»åŠ éµç›¤æ”¯æŒ
            document.querySelectorAll('.d-btn').forEach(btn => {
                btn.setAttribute('tabindex', '0');
                btn.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const d = btn.dataset.dir;
                        if(d==='up' && direction!=='down') nextDirection='up';
                        if(d==='down' && direction!=='up') nextDirection='down';
                        if(d==='left' && direction!=='right') nextDirection='left';
                        if(d==='right' && direction!=='left') nextDirection='right';
                    }
                });
            });
        }

        setupFocusManagement() {
            // è¨­ç½®ç„¦é»é™·é˜±åœ¨æ¨¡æ…‹æ¡†ä¸­
            const modal = dom.display.modal;
            if(modal) {
                modal.addEventListener('keydown', (e) => {
                    if(e.key === 'Tab') {
                        this.trapFocus(e, modal);
                    }
                });
            }
        }

        selectAccessory(btn) {
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.accessory-option').forEach(opt => {
                opt.classList.remove('active');
                opt.setAttribute('aria-checked', 'false');
            });
            
            // è¨­ç½®æ–°é¸ä¸­ç‹€æ…‹
            btn.classList.add('active');
            btn.setAttribute('aria-checked', 'true');
            player.skin.accessory = btn.dataset.acc;
            savePlayer();
            
            // å®£å¸ƒé¸æ“‡
            const accessoryName = btn.getAttribute('aria-label');
            this.announce(`å·²é¸æ“‡ ${accessoryName}`);
        }

        navigateAccessories(direction) {
            const accessories = Array.from(document.querySelectorAll('.accessory-option'));
            const currentIndex = accessories.findIndex(btn => btn.classList.contains('active'));
            let newIndex = currentIndex + direction;
            
            if(newIndex < 0) newIndex = accessories.length - 1;
            if(newIndex >= accessories.length) newIndex = 0;
            
            accessories[newIndex].focus();
            this.selectAccessory(accessories[newIndex]);
        }

        handleTabNavigation(e) {
            // å¯¦ç¾é‚è¼¯Tabå°èˆª
            const focusableElements = document.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if(e.shiftKey) {
                if(document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                }
            } else {
                if(document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        }

        trapFocus(e, container) {
            const focusableElements = container.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if(e.shiftKey) {
                if(document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                }
            } else {
                if(document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        }

        announce(message) {
            // å±å¹•é–±è®€å™¨å…¬å‘Š
            this.announcementQueue.push(message);
            if(!this.isAnnouncing) {
                this.processAnnouncementQueue();
            }
        }

        processAnnouncementQueue() {
            if(this.announcementQueue.length === 0) {
                this.isAnnouncing = false;
                return;
            }

            this.isAnnouncing = true;
            const message = this.announcementQueue.shift();
            
            // å‰µå»ºè‡¨æ™‚å…¬å‘Šå…ƒç´ 
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
                this.processAnnouncementQueue();
            }, 100);
        }

        announceDirection(direction) {
            // å…¬å‘Šç§»å‹•æ–¹å‘
            if(isPlaying && !isPaused) {
                this.announce(`å‘${direction}ç§»å‹•`);
            }
        }

        announceGameState() {
            // å…¬å‘ŠéŠæˆ²ç‹€æ…‹
            if(isGameOver) {
                this.announce(`éŠæˆ²çµæŸï¼Œæœ€çµ‚åˆ†æ•¸ ${score} åˆ†`);
            } else if(isPaused) {
                this.announce('éŠæˆ²å·²æš«åœ');
            } else if(isPlaying) {
                this.announce(`éŠæˆ²é€²è¡Œä¸­ï¼Œåˆ†æ•¸ ${score} åˆ†ï¼Œè›‡èº«é•·åº¦ ${snake.length}`);
            }
        }

        showKeyboardHint() {
            // é¡¯ç¤ºéµç›¤æ“ä½œæç¤º
            const hint = document.createElement('div');
            hint.className = 'keyboard-hint';
            hint.innerHTML = `
                <strong>éµç›¤æ“ä½œï¼š</strong><br>
                â€¢ æ–¹å‘éµæˆ– WASDï¼šæ§åˆ¶ç§»å‹•<br>
                â€¢ ç©ºæ ¼éµæˆ– Escï¼šæš«åœéŠæˆ²<br>
                â€¢ Tabï¼šå°èˆªç•Œé¢å…ƒç´ <br>
                â€¢ Enterï¼šç¢ºèªé¸æ“‡
            `;
            document.body.appendChild(hint);
            
            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                if(hint.parentNode) {
                    hint.remove();
                }
            }, 5000);
        }
    }

    // åŸæœ‰çš„è¼¸å…¥è™•ç†
    document.addEventListener('keydown', e => {
        const key = e.key;
        if(['ArrowUp','w'].includes(key) && direction!=='down') nextDirection='up';
        if(['ArrowDown','s'].includes(key) && direction!=='up') nextDirection='down';
        if(['ArrowLeft','a'].includes(key) && direction!=='right') nextDirection='left';
        if(['ArrowRight','d'].includes(key) && direction!=='left') nextDirection='right';
    });

    document.querySelectorAll('.d-btn').forEach(btn => {
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const d = btn.dataset.dir;
            if(d==='up' && direction!=='down') nextDirection='up';
            if(d==='down' && direction!=='up') nextDirection='down';
            if(d==='left' && direction!=='right') nextDirection='left';
            if(d==='right' && direction!=='left') nextDirection='right';
        });
    });

    // æˆå°±ç³»çµ±åŠŸèƒ½
    function showAchievementPopup(achievement) {
        const popup = document.getElementById('achievementPopup');
        const icon = document.getElementById('achievementIcon');
        const title = document.getElementById('achievementTitle');
        const desc = document.getElementById('achievementDesc');
        
        icon.textContent = achievement.icon;
        title.textContent = achievement.name;
        desc.textContent = achievement.desc;
        
        popup.classList.remove('hidden');
        haptic.provideFeedback('achievement');
        
        setTimeout(() => {
            popup.classList.add('hidden');
        }, 4000);
    }

    function openAchievementsPanel() {
        const panel = document.getElementById('achievementsPanel');
        const grid = document.getElementById('achievementsGrid');
        
        // æ¸…ç©ºç¾æœ‰å…§å®¹
        grid.innerHTML = '';
        
        // ç”Ÿæˆæˆå°±é …ç›®
        Object.values(achievements).forEach(achievement => {
            const isUnlocked = player.achievements.includes(achievement.id);
            const item = document.createElement('div');
            item.className = `achievement-item ${isUnlocked ? 'unlocked' : ''}`;
            item.innerHTML = `
                <div class="achievement-item-icon">${isUnlocked ? achievement.icon : 'ğŸ”’'}</div>
                <div class="achievement-item-name">${achievement.name}</div>
                <div class="achievement-item-desc">${achievement.desc}</div>
            `;
            grid.appendChild(item);
        });
        
        panel.classList.remove('hidden');
        sfx.playSound('button');
    }

    function closeAchievementsPanel() {
        const panel = document.getElementById('achievementsPanel');
        panel.classList.add('hidden');
        sfx.playSound('button');
    }

    // è¨­ç½®æˆå°±é¢æ¿äº‹ä»¶
    document.getElementById('achievementsBtn').addEventListener('click', openAchievementsPanel);
    document.getElementById('closeAchievements').addEventListener('click', closeAchievementsPanel);
    
    // é»æ“Šé¢æ¿å¤–éƒ¨é—œé–‰
    document.getElementById('achievementsPanel').addEventListener('click', (e) => {
        if (e.target.id === 'achievementsPanel') {
            closeAchievementsPanel();
        }
    });

    // å¢å¼·çš„è¼¸å…¥è™•ç†
    document.addEventListener('keydown', e => {
        const key = e.key;
        
        // éŠæˆ²æ§åˆ¶
        if(dom.gameInterface.style.display !== 'none') {
            if(['ArrowUp','w','W'].includes(key) && direction!=='down') {
                nextDirection='up';
                sfx.playMoveSequence('up');
                haptic.provideFeedback('move');
            }
            if(['ArrowDown','s','S'].includes(key) && direction!=='up') {
                nextDirection='down';
                sfx.playMoveSequence('down');
                haptic.provideFeedback('move');
            }
            if(['ArrowLeft','a','A'].includes(key) && direction!=='right') {
                nextDirection='left';
                sfx.playMoveSequence('left');
                haptic.provideFeedback('move');
            }
            if(['ArrowRight','d','D'].includes(key) && direction!=='left') {
                nextDirection='right';
                sfx.playMoveSequence('right');
                haptic.provideFeedback('move');
            }
        }
        
        // Aéµæ‰“é–‹æˆå°±é¢æ¿ï¼ˆåœ¨éŠæˆ²ä¸­ï¼‰
        if (key === 'a' || key === 'A') {
            if (document.activeElement === gameCanvas) {
                openAchievementsPanel();
            }
        }
    });

    // å•Ÿå‹•
    initLobby();
    
    // åˆå§‹åŒ–ç®¡ç†å™¨
    const haptic = new HapticFeedbackManager();
    const microInteractions = new MicroInteractionsManager();
    window.accessibilityManager = new AccessibilityManager();
    
    // è¨­ç½®Canvasç„¦é»æ”¯æŒ
    const gameCanvasElement = document.getElementById('gameCanvas');
    gameCanvasElement.addEventListener('focus', () => {
        if(window.accessibilityManager && isPlaying) {
            window.accessibilityManager.announceGameState();
        }
    });

</script>
</body>
</html>