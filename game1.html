<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²ªé£Ÿè›‡ RPG - ç©å®¶ä¸»é ç‰ˆ</title>
    <style>
        :root {
            --primary: #4caf50;
            --accent: #ff9800;
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --border: #333;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        /* å®¹å™¨ */
        #main-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #000;
        }

        /* -----------------------
           å¤§å»³/ä¸»é æ¨£å¼
           ----------------------- */
        .lobby-screen {
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
            z-index: 20;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-header h1 {
            font-size: 2.5rem;
            margin: 10px 0;
            background: linear-gradient(90deg, var(--primary), #81c784);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .avatar-preview-box {
            width: 100px;
            height: 100px;
            background: #222;
            border-radius: 50%;
            border: 4px solid var(--primary);
            margin: 0 auto;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        
        .avatar-preview-box canvas {
            width: 100%;
            height: 100%;
        }

        /* é¸é …å¡ç‰‡ */
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .card h3 {
            margin-top: 0;
            color: var(--accent);
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group label {
            color: var(--text-muted);
        }

        input[type="text"] {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1rem;
            width: 60%;
        }

        input[type="color"] {
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            background: none;
        }

        /* é…ä»¶é¸æ“‡å™¨ */
        .accessory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .accessory-option {
            background: #333;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 24px;
        }

        .accessory-option:hover {
            background: #444;
        }

        .accessory-option.active {
            border-color: var(--accent);
            background: rgba(255, 152, 0, 0.1);
        }

        .btn-large {
            background: linear-gradient(to right, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            width: 100%;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: transform 0.1s;
        }

        .btn-large:active {
            transform: scale(0.98);
        }

        /* -----------------------
           éŠæˆ²ä»‹é¢æ¨£å¼
           ----------------------- */
        .game-interface {
            display: none; /* é è¨­éš±è— */
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        .hud-top {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: rgba(30, 30, 30, 0.8);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .hud-label { font-size: 0.8rem; color: #888; }
        .hud-value { font-size: 1.2rem; color: #fff; font-weight: bold; }

        canvas#gameCanvas {
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
        }

        /* æ¨¡æ…‹æ¡† (æš«åœ/çµæŸ) */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .hidden { display: none !important; }

        .btn {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-primary { background: var(--primary); border-color: var(--primary); }
        .btn-danger { background: #e53935; border-color: #e53935; }

        /* æ‰‹æ©Ÿæ§åˆ¶ */
        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(2, 60px);
            gap: 10px;
            margin-top: 15px;
        }
        .d-btn {
            background: #333; border: 1px solid #444; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #888; user-select: none;
        }
        .d-btn:active { background: #555; }
        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

    </style>
</head>
<body>

<div id="main-container">
    
    <!-- 1. ç©å®¶å¤§å»³ -->
    <div id="lobby" class="lobby-screen">
        <div class="profile-header">
            <div class="avatar-preview-box">
                <canvas id="avatarCanvas" width="100" height="100"></canvas>
            </div>
            <h1>è²ªé£Ÿè›‡ RPG</h1>
            <p style="color:#888">æ‰“é€ ä½ çš„å°ˆå±¬æˆ°å ´é¢¨æ ¼</p>
        </div>

        <!-- åå­—è¨­å®š -->
        <div class="card">
            <h3>ç©å®¶è³‡æ–™</h3>
            <div class="input-group">
                <label>æš±ç¨±</label>
                <input type="text" id="playerNameInput" value="Player" maxlength="10">
            </div>
            <div class="input-group">
                <label>æœ€é«˜åˆ†</label>
                <span id="lobbyHighScore" style="color: var(--primary); font-weight: bold;">0</span>
            </div>
            <div class="input-group">
                <label>ç¸½å ´æ¬¡</label>
                <span id="lobbyGamesPlayed">0</span>
            </div>
        </div>

        <!-- å¤–è§€è¨­å®š -->
        <div class="card">
            <h3>å¤–å‹å®¢è£½åŒ–</h3>
            <div class="input-group">
                <label>è›‡é ­é¡è‰²</label>
                <input type="color" id="colorHead" value="#4caf50">
            </div>
            <div class="input-group">
                <label>èº«é«”é¡è‰² (æ·±)</label>
                <input type="color" id="colorBody1" value="#2e7d32">
            </div>
            <div class="input-group">
                <label>èº«é«”é¡è‰² (æ·º)</label>
                <input type="color" id="colorBody2" value="#388e3c">
            </div>
            
            <div style="margin-top: 15px;">
                <label style="display:block; margin-bottom:10px; color:var(--text-muted)">é¸æ“‡é…ä»¶</label>
                <div class="accessory-grid">
                    <div class="accessory-option active" data-acc="none" title="ç„¡">ğŸš«</div>
                    <div class="accessory-option" data-acc="glasses" title="å¢¨é¡">ğŸ•¶ï¸</div>
                    <div class="accessory-option" data-acc="hat" title="ç¦®å¸½">ğŸ©</div>
                    <div class="accessory-option" data-acc="crown" title="çš‡å† ">ğŸ‘‘</div>
                </div>
            </div>
        </div>

        <button class="btn-large" id="startGameBtn">é–‹å§‹éŠæˆ²</button>
        <div style="margin-top:10px; color:#666; font-size:0.8rem;">è¨­å®šæœƒè‡ªå‹•ä¿å­˜</div>
    </div>

    <!-- 2. éŠæˆ²ä»‹é¢ -->
    <div id="gameInterface" class="game-interface">
        <div class="hud-top">
            <div class="hud-item">
                <span class="hud-label">ç©å®¶</span>
                <span class="hud-value" id="gamePlayerName">Player</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">åˆ†æ•¸</span>
                <span class="hud-value" id="gameScore">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">é•·åº¦</span>
                <span class="hud-value" id="gameLength">3</span>
            </div>
        </div>

        <canvas id="gameCanvas" width="400" height="400"></canvas>
        
        <div style="margin-top:5px; color:#888; font-size:0.8rem; display:flex; justify-content:center; gap:15px;">
            <span>ğŸ”´ æ™®é€š +10</span>
            <span>ğŸŒŸ é‡‘è˜‹æœ +20</span>
            <span>â˜ ï¸ æ¯’è˜‹æœ æ­»äº¡</span>
        </div>

        <div class="mobile-controls">
            <div class="d-btn up" data-dir="up">â–²</div>
            <div class="d-btn left" data-dir="left">â—€</div>
            <div class="d-btn down" data-dir="down">â–¼</div>
            <div class="d-btn right" data-dir="right">â–¶</div>
        </div>

        <!-- éŠæˆ²çµæŸ/æš«åœé®ç½© -->
        <div id="gameModal" class="modal-overlay hidden">
            <h2 id="modalTitle" style="color:white; font-size:2rem;">éŠæˆ²çµæŸ</h2>
            <p id="modalScore" style="color:#aaa; margin:10px 0;">åˆ†æ•¸: 0</p>
            <p id="modalReason" style="color:#ff5252; font-size:0.9rem;">æ’ç‰†äº†</p>
            <div style="margin-top:20px;">
                <button class="btn btn-primary" id="modalRestartBtn">é‡ç©</button>
                <button class="btn" id="modalHomeBtn">è¿”å›ä¸»é </button>
            </div>
            <button class="btn" id="modalPauseBtn" style="margin-top:10px; display:none;">ç¹¼çºŒéŠæˆ²</button>
        </div>
        
        <button id="miniPauseBtn" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); border:none; color:white; padding:5px; font-size:20px; cursor:pointer;">II</button>
    </div>

</div>

<script>
    /**
     * ç©å®¶è³‡æ–™ç®¡ç†ç³»çµ±
     */
    const defaultPlayer = {
        name: "SnakeLover",
        highScore: 0,
        gamesPlayed: 0,
        skin: {
            head: "#4caf50",
            body1: "#2e7d32",
            body2: "#388e3c",
            accessory: "none" // none, glasses, hat, crown
        }
    };

    let player = JSON.parse(localStorage.getItem('snakeRPG_Player')) || defaultPlayer;
    
    // DOM å…ƒç´ 
    const dom = {
        lobby: document.getElementById('lobby'),
        gameInterface: document.getElementById('gameInterface'),
        inputs: {
            name: document.getElementById('playerNameInput'),
            head: document.getElementById('colorHead'),
            body1: document.getElementById('colorBody1'),
            body2: document.getElementById('colorBody2'),
        },
        display: {
            highScore: document.getElementById('lobbyHighScore'),
            gamesPlayed: document.getElementById('lobbyGamesPlayed'),
            gamePlayerName: document.getElementById('gamePlayerName'),
            gameScore: document.getElementById('gameScore'),
            gameLength: document.getElementById('gameLength'),
            modalTitle: document.getElementById('modalTitle'),
            modalScore: document.getElementById('modalScore'),
            modalReason: document.getElementById('modalReason'),
            modal: document.getElementById('gameModal')
        },
        avatarCanvas: document.getElementById('avatarCanvas'),
        gameCanvas: document.getElementById('gameCanvas')
    };

    // åˆå§‹åŒ–å¤§å»³è³‡æ–™
    function initLobby() {
        dom.inputs.name.value = player.name;
        dom.inputs.head.value = player.skin.head;
        dom.inputs.body1.value = player.skin.body1;
        dom.inputs.body2.value = player.skin.body2;
        
        dom.display.highScore.textContent = player.highScore;
        dom.display.gamesPlayed.textContent = player.gamesPlayed;

        // è¨­å®šé…ä»¶é¸å–ç‹€æ…‹
        document.querySelectorAll('.accessory-option').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.acc === player.skin.accessory) {
                el.classList.add('active');
            }
        });

        updateAvatarPreview();
    }

    // å„²å­˜è³‡æ–™
    function savePlayer() {
        player.name = dom.inputs.name.value || "Anonymous";
        player.skin.head = dom.inputs.head.value;
        player.skin.body1 = dom.inputs.body1.value;
        player.skin.body2 = dom.inputs.body2.value;
        
        localStorage.setItem('snakeRPG_Player', JSON.stringify(player));
        dom.display.highScore.textContent = player.highScore;
        updateAvatarPreview();
    }

    // äº‹ä»¶ç›£è½ï¼šè¼¸å…¥è®ŠåŒ–æ™‚å³æ™‚æ›´æ–°
    Object.values(dom.inputs).forEach(input => {
        input.addEventListener('input', savePlayer);
    });

    // äº‹ä»¶ç›£è½ï¼šé…ä»¶é¸æ“‡
    document.querySelectorAll('.accessory-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.accessory-option').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
            player.skin.accessory = el.dataset.acc;
            savePlayer();
        });
    });

    // ç¹ªè£½å¤§å»³é ­åƒé è¦½
    function updateAvatarPreview() {
        const ctx = dom.avatarCanvas.getContext('2d');
        const s = 100;
        ctx.clearRect(0,0,s,s);
        
        // èº«é«”
        ctx.fillStyle = player.skin.body1;
        ctx.fillRect(20, 50, 60, 40);
        ctx.fillStyle = player.skin.body2;
        ctx.fillRect(20, 70, 60, 20);
        
        // é ­
        ctx.fillStyle = player.skin.head;
        ctx.beginPath();
        ctx.arc(50, 40, 25, 0, Math.PI*2);
        ctx.fill();
        
        // çœ¼ç›
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(40, 35, 6, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(60, 35, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(42, 35, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(58, 35, 2, 0, Math.PI*2); ctx.fill();

        // é…ä»¶é è¦½
        drawAccessory(ctx, 50, 40, 25, 'right', player.skin.accessory);
    }

    /* ----------------------------------------
       éŠæˆ²æ ¸å¿ƒé‚è¼¯
       ---------------------------------------- */
    const canvas = dom.gameCanvas;
    const ctx = canvas.getContext('2d');
    
    let snake = [];
    let food = { x:0, y:0, type:'normal' };
    let direction = 'right';
    let nextDirection = 'right';
    let score = 0;
    let gameSpeed = 130;
    let isPaused = false;
    let isGameOver = false;
    let gameLoopId;
    let lastTime = 0;

    // éŸ³æ•ˆ
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        
        if (type === 'eat') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(1000, now+0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if (type === 'gold') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(1200, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now+0.2);
            osc.start(now); osc.stop(now+0.2);
        } else if (type === 'die') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(20, now+0.3);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        }
    }

    // åˆ‡æ›ç•«é¢
    document.getElementById('startGameBtn').addEventListener('click', () => {
        dom.lobby.style.display = 'none';
        dom.gameInterface.style.display = 'flex';
        dom.display.gamePlayerName.textContent = player.name;
        initGame();
    });

    document.getElementById('modalHomeBtn').addEventListener('click', () => {
        dom.gameInterface.style.display = 'none';
        dom.lobby.style.display = 'flex';
        initLobby(); // åˆ·æ–°è³‡æ–™
    });

    document.getElementById('modalRestartBtn').addEventListener('click', () => {
        dom.display.modal.classList.add('hidden');
        initGame();
    });

    document.getElementById('modalPauseBtn').addEventListener('click', togglePause);
    document.getElementById('miniPauseBtn').addEventListener('click', togglePause);

    function initGame() {
        snake = [{x:10,y:10}, {x:9,y:10}, {x:8,y:10}];
        score = 0;
        direction = 'right';
        nextDirection = 'right';
        gameSpeed = 130;
        isGameOver = false;
        isPaused = false;
        
        spawnFood();
        updateGameUI();
        
        dom.display.modal.classList.add('hidden');
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    function spawnFood() {
        let valid = false;
        while(!valid) {
            food.x = Math.floor(Math.random() * (canvas.width/20));
            food.y = Math.floor(Math.random() * (canvas.height/20));
            valid = !snake.some(s => s.x===food.x && s.y===food.y);
        }
        const r = Math.random();
        food.type = r < 0.05 ? 'poison' : (r < 0.15 ? 'gold' : 'normal');
    }

    function togglePause() {
        if(isGameOver) return;
        isPaused = !isPaused;
        if(isPaused) {
            dom.display.modalTitle.textContent = "å·²æš«åœ";
            dom.display.modalScore.textContent = `ç›®å‰åˆ†æ•¸: ${score}`;
            dom.display.modalReason.textContent = "";
            dom.display.modal.classList.remove('hidden');
            document.getElementById('modalRestartBtn').style.display = 'none';
            document.getElementById('modalHomeBtn').style.display = 'inline-block';
            document.getElementById('modalPauseBtn').style.display = 'inline-block';
            document.getElementById('modalPauseBtn').textContent = "ç¹¼çºŒéŠæˆ²";
        } else {
            dom.display.modal.classList.add('hidden');
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }
    }

    function gameLoop(timestamp) {
        if(isPaused || isGameOver) return;
        if(timestamp - lastTime > gameSpeed) {
            update();
            lastTime = timestamp;
        }
        draw();
        if(!isPaused && !isGameOver) requestAnimationFrame(gameLoop);
    }

    function update() {
        direction = nextDirection;
        const head = {...snake[0]};
        if(direction==='right') head.x++;
        if(direction==='left') head.x--;
        if(direction==='up') head.y--;
        if(direction==='down') head.y++;

        const gw = canvas.width/20;
        const gh = canvas.height/20;

        // æ­»äº¡åˆ¤å®š
        if(head.x<0 || head.x>=gw || head.y<0 || head.y>=gh || snake.some(s=>s.x===head.x && s.y===head.y)) {
            gameOver("ä½ æ’è»Šäº†ï¼");
            return;
        }

        snake.unshift(head);

        // åƒé£Ÿç‰©
        if(head.x===food.x && head.y===food.y) {
            if(food.type === 'poison') {
                gameOver("ä¸­æ¯’èº«äº¡ï¼");
                return;
            }
            score += (food.type === 'gold' ? 20 : 10);
            if(food.type === 'gold') gameSpeed = Math.max(60, gameSpeed - 3);
            playSound(food.type === 'gold' ? 'gold' : 'eat');
            spawnFood();
        } else {
            snake.pop();
        }
        updateGameUI();
    }

    function gameOver(reason) {
        isGameOver = true;
        playSound('die');
        
        // æ›´æ–°ç©å®¶è³‡æ–™
        player.gamesPlayed++;
        if(score > player.highScore) {
            player.highScore = score;
            reason = "æ–°ç´€éŒ„ï¼ " + reason;
        }
        localStorage.setItem('snakeRPG_Player', JSON.stringify(player));

        // é¡¯ç¤ºçµç®—
        dom.display.modalTitle.textContent = "éŠæˆ²çµæŸ";
        dom.display.modalScore.textContent = `æœ€çµ‚åˆ†æ•¸: ${score}`;
        dom.display.modalReason.textContent = reason;
        dom.display.modal.classList.remove('hidden');
        document.getElementById('modalRestartBtn').style.display = 'inline-block';
        document.getElementById('modalHomeBtn').style.display = 'inline-block';
        document.getElementById('modalPauseBtn').style.display = 'none';
    }

    function updateGameUI() {
        dom.display.gameScore.textContent = score;
        dom.display.gameLength.textContent = snake.length;
    }

    /* -----------------------
       ç¹ªåœ–ç³»çµ± (æ”¯æ´å¤–å‹èˆ‡é…ä»¶)
       ----------------------- */
    function draw() {
        // èƒŒæ™¯
        ctx.fillStyle = "#050505";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        
        // ç¶²æ ¼
        ctx.strokeStyle = "#1a1a1a";
        ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=20) {
            ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke();
        }
        for(let i=0; i<canvas.height; i+=20) {
            ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke();
        }

        // é£Ÿç‰©
        const fx = food.x*20 + 10;
        const fy = food.y*20 + 10;
        ctx.fillStyle = food.type==='normal'?'#ff5252' : (food.type==='gold'?'#ffd700':'#9c27b0');
        if(food.type==='gold') ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
        ctx.beginPath(); ctx.arc(fx, fy, 8, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur=0;

        // è›‡
        snake.forEach((seg, i) => {
            const isHead = i===0;
            const x = seg.x * 20;
            const y = seg.y * 20;
            
            ctx.fillStyle = (i%2===0) ? player.skin.body1 : player.skin.body2;
            if(isHead) ctx.fillStyle = player.skin.head;
            
            // åœ“è§’
            ctx.beginPath();
            const r = isHead ? 8 : 4;
            ctx.roundRect(x+1, y+1, 18, 18, r);
            ctx.fill();

            if(isHead) {
                // çœ¼ç›
                ctx.fillStyle = "white";
                let ex = x+10, ey = y+10;
                let off = 0;
                if(direction==='right') off=4;
                if(direction==='left') off=-4;
                if(direction==='down') off=4; // yè»¸åç§»ç°¡åŒ–è™•ç†ï¼Œåªåšxè»¸æ˜é¡¯é»
                // é€™è£¡ç°¡åŒ–çœ¼ç›ä½ç½®ï¼Œä¸éš¨æ—‹è½‰è¤‡é›œè¨ˆç®—ï¼Œåƒ…ç¤ºæ„
                let eyeX1 = (direction==='right'?14 : (direction==='left'?6 : 6));
                let eyeY1 = (direction==='down'?14 : 6);
                
                ctx.beginPath(); ctx.arc(x+eyeX1, y+eyeY1, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(x+eyeX1+1, y+eyeY1, 1, 0, Math.PI*2); ctx.fill();

                // ç¹ªè£½é…ä»¶
                drawAccessory(ctx, x+10, y+10, 10, direction, player.skin.accessory);
            }
        });
    }

    // é…ä»¶ç¹ªè£½é‚è¼¯
    function drawAccessory(ctx, cx, cy, r, dir, type) {
        ctx.save();
        ctx.translate(cx, cy);
        
        // æ ¹æ“šæ–¹å‘æ—‹è½‰ç•«å¸ƒ
        let angle = 0;
        if(dir==='right') angle = 0;
        if(dir==='down') angle = Math.PI/2;
        if(dir==='left') angle = Math.PI;
        if(dir==='up') angle = -Math.PI/2;
        ctx.rotate(angle);

        if(type === 'glasses') {
            ctx.fillStyle = "black";
            ctx.fillRect(0, -6, 12, 6); // é¡æ¡†
            ctx.fillRect(-8, -6, 6, 6); 
            ctx.fillRect(0, -3, 4, 1); // é¼»æ¨‘
        } else if(type === 'hat') {
            ctx.fillStyle = "#222";
            ctx.fillRect(-8, -12, 16, 12); // å¸½èº«
            ctx.fillStyle = "#333";
            ctx.fillRect(-12, 0, 24, 3); // å¸½ç°·
            ctx.fillStyle = "#d32f2f";
            ctx.fillRect(-4, -14, 8, 2); // è£é£¾å¸¶
        } else if(type === 'crown') {
            ctx.fillStyle = "#ffd700";
            ctx.beginPath();
            ctx.moveTo(-8, -2);
            ctx.lineTo(-6, -12); ctx.lineTo(0, -6);
            ctx.lineTo(6, -12); ctx.lineTo(8, -2);
            ctx.fill();
            ctx.fillStyle = "#ffeb3b";
            ctx.beginPath(); ctx.arc(0, -9, 2, 0, Math.PI*2); ctx.fill();
        }

        ctx.restore();
    }

    // è¼¸å…¥è™•ç†
    document.addEventListener('keydown', e => {
        const key = e.key;
        if(['ArrowUp','w'].includes(key) && direction!=='down') nextDirection='up';
        if(['ArrowDown','s'].includes(key) && direction!=='up') nextDirection='down';
        if(['ArrowLeft','a'].includes(key) && direction!=='right') nextDirection='left';
        if(['ArrowRight','d'].includes(key) && direction!=='left') nextDirection='right';
    });

    document.querySelectorAll('.d-btn').forEach(btn => {
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const d = btn.dataset.dir;
            if(d==='up' && direction!=='down') nextDirection='up';
            if(d==='down' && direction!=='up') nextDirection='down';
            if(d==='left' && direction!=='right') nextDirection='left';
            if(d==='right' && direction!=='left') nextDirection='right';
        });
    });

    // å•Ÿå‹•
    initLobby();

</script>
</body>
</html>